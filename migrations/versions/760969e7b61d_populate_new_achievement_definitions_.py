"""Populate new achievement definitions data

Revision ID: 760969e7b61d
Revises: 03b74d3f953e
Create Date: 2025-05-09 13:35:00.190678

"""
from alembic import op
import sqlalchemy as sa
# from sqlalchemy.dialects.postgresql import JSONB # PostgreSQLå›ºæœ‰ã®å‹ã‚’ä½¿ã„ãŸã„å ´åˆ
# sqlalchemy.JSON ã‚’ä½¿ç”¨ã™ã‚‹æ–¹ãŒãƒãƒ¼ã‚¿ãƒ–ãƒ«ãªå ´åˆãŒã‚ã‚Šã¾ã™

# ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®å®šæ•° (motopuppu/achievement_evaluator.py ã¨åˆã‚ã›ã‚‹)
EVENT_ADD_VEHICLE = "add_vehicle"
EVENT_ADD_FUEL_LOG = "add_fuel_log"
EVENT_ADD_MAINTENANCE_LOG = "add_maintenance_log"
EVENT_ADD_NOTE = "add_note"
# EVENT_ADD_ODO_RESET ã¯æ—¢å­˜ã®åˆå›å®Ÿç¸¾ã§ä½¿ç”¨

# revision identifiers, used by Alembic.
revision = '760969e7b61d'
down_revision = '03b74d3f953e'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - START ###
    # with op.batch_alter_table('users', schema=None) as batch_op:
    #     batch_op.alter_column('misskey_user_id',
    #            existing_type=sa.VARCHAR(length=100),
    #            comment='username for miskey', # ã“ã®ãƒ€ãƒŸãƒ¼å¤‰æ›´ã¯å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã¨ã¯ç„¡é–¢ä¿‚ãªã®ã§å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    #            existing_nullable=False)
    # ### commands auto generated by Alembic - END ###

    # â–¼â–¼â–¼ å®Ÿç¸¾å®šç¾©ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥å‡¦ç†ã‚’ã“ã“ã‹ã‚‰è¨˜è¿° â–¼â–¼â–¼
    achievement_definitions_table = sa.table(
        'achievement_definitions',
        sa.column('code', sa.String),
        sa.column('name', sa.String),
        sa.column('description', sa.Text),
        sa.column('icon_class', sa.String),
        sa.column('category_code', sa.String),
        sa.column('category_name', sa.String),
        sa.column('share_text_template', sa.Text),
        sa.column('trigger_event_type', sa.String),
        sa.column('criteria', sa.JSON) 
    )

    new_achievements_data = [
        # --- å›æ•°ç³»å®Ÿç¸¾: çµ¦æ²¹ ---
        {'code': 'FUEL_LOG_COUNT_10', 'name': 'çµ¦æ²¹10å›é”æˆï¼', 'description': 'çµ¦æ²¹è¨˜éŒ²ã‚’10å›è¿½åŠ ã™ã‚‹', 'icon_class': 'fas fa-tint', 'category_code': 'fuel', 'category_name': 'çµ¦æ²¹è¨˜éŒ²', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼çµ¦æ²¹10å›é”æˆï¼â›½ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_FUEL_LOG, 'criteria': {"type": "count", "target_model": "FuelEntry", "value": 10}},
        {'code': 'FUEL_LOG_COUNT_50', 'name': 'çµ¦æ²¹50å›é”æˆï¼', 'description': 'çµ¦æ²¹è¨˜éŒ²ã‚’50å›è¿½åŠ ã™ã‚‹', 'icon_class': 'fas fa-gas-pump', 'category_code': 'fuel', 'category_name': 'çµ¦æ²¹è¨˜éŒ²', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼çµ¦æ²¹50å›ï¼ã™ã”ã„ï¼â›½ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_FUEL_LOG, 'criteria': {"type": "count", "target_model": "FuelEntry", "value": 50}},
        {'code': 'FUEL_LOG_COUNT_100', 'name': 'çµ¦æ²¹100å›é”æˆï¼', 'description': 'çµ¦æ²¹è¨˜éŒ²ã‚’100å›è¿½åŠ ã™ã‚‹', 'icon_class': 'fas fa-fire-alt', 'category_code': 'fuel', 'category_name': 'çµ¦æ²¹è¨˜éŒ²', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼çµ¦æ²¹100å›ã€ã‚‚ã¯ã‚„ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ï¼â›½ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_FUEL_LOG, 'criteria': {"type": "count", "target_model": "FuelEntry", "value": 100}},
        # --- å›æ•°ç³»å®Ÿç¸¾: æ•´å‚™ ---
        {'code': 'MAINT_LOG_COUNT_10', 'name': 'æ•´å‚™10å›é”æˆï¼', 'description': 'æ•´å‚™è¨˜éŒ²ã‚’10å›è¿½åŠ ã™ã‚‹', 'icon_class': 'fas fa-tools', 'category_code': 'maintenance', 'category_name': 'æ•´å‚™è¨˜éŒ²', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼æ•´å‚™10å›ï¼ãƒã‚¤ã‚¯ã‚‚ãƒ”ã‚«ãƒ”ã‚«ï¼ğŸ”§ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_MAINTENANCE_LOG, 'criteria': {"type": "count", "target_model": "MaintenanceEntry", "value": 10}},
        {'code': 'MAINT_LOG_COUNT_50', 'name': 'æ•´å‚™50å›é”æˆï¼', 'description': 'æ•´å‚™è¨˜éŒ²ã‚’50å›è¿½åŠ ã™ã‚‹', 'icon_class': 'fas fa-cogs', 'category_code': 'maintenance', 'category_name': 'æ•´å‚™è¨˜éŒ²', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼æ•´å‚™50å›ï¼æ•´å‚™ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ï¼ğŸ”§ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_MAINTENANCE_LOG, 'criteria': {"type": "count", "target_model": "MaintenanceEntry", "value": 50}},
        {'code': 'MAINT_LOG_COUNT_100', 'name': 'æ•´å‚™100å›é”æˆï¼', 'description': 'æ•´å‚™è¨˜éŒ²ã‚’100å›è¿½åŠ ã™ã‚‹', 'icon_class': 'fas fa-user-cog', 'category_code': 'maintenance', 'category_name': 'æ•´å‚™è¨˜éŒ²', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼æ•´å‚™100å›ï¼ç¥ã®æ‰‹ã‚’æŒã¤è€…ï¼ğŸ”§ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_MAINTENANCE_LOG, 'criteria': {"type": "count", "target_model": "MaintenanceEntry", "value": 100}},
        # --- å›æ•°ç³»å®Ÿç¸¾: ãƒãƒ¼ãƒˆ ---
        {'code': 'NOTE_COUNT_10', 'name': 'ãƒãƒ¼ãƒˆ10ä»¶ä½œæˆï¼', 'description': 'ãƒãƒ¼ãƒˆ/ã‚¿ã‚¹ã‚¯ã‚’10ä»¶è¨˜éŒ²ã™ã‚‹', 'icon_class': 'fas fa-book-open', 'category_code': 'general', 'category_name': 'ãã®ä»–', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼ãƒãƒ¼ãƒˆ10ä»¶ï¼è¨˜éŒ²ãŒè»Œè·¡ã‚’å‰µã‚‹ï¼ğŸ“ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_NOTE, 'criteria': {"type": "count", "target_model": "GeneralNote", "value": 10}},
        {'code': 'NOTE_COUNT_50', 'name': 'ãƒãƒ¼ãƒˆ50ä»¶ä½œæˆï¼', 'description': 'ãƒãƒ¼ãƒˆ/ã‚¿ã‚¹ã‚¯ã‚’50ä»¶è¨˜éŒ²ã™ã‚‹', 'icon_class': 'fas fa-archive', 'category_code': 'general', 'category_name': 'ãã®ä»–', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼ãƒãƒ¼ãƒˆ50ä»¶ï¼ã‚ãªãŸã®ãƒã‚¤ã‚¯ç‰©èªï¼ğŸ“ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_NOTE, 'criteria': {"type": "count", "target_model": "GeneralNote", "value": 50}},
        {'code': 'NOTE_COUNT_100', 'name': 'ãƒãƒ¼ãƒˆ100ä»¶ä½œæˆï¼', 'description': 'ãƒãƒ¼ãƒˆ/ã‚¿ã‚¹ã‚¯ã‚’100ä»¶è¨˜éŒ²ã™ã‚‹', 'icon_class': 'fas fa-landmark', 'category_code': 'general', 'category_name': 'ãã®ä»–', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼ãƒãƒ¼ãƒˆ100ä»¶ï¼æ­´å²ã®ç·¨çº‚è€…ï¼ğŸ“ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_NOTE, 'criteria': {"type": "count", "target_model": "GeneralNote", "value": 100}},

        # --- èµ°è¡Œè·é›¢é”æˆç³» (ç‰¹å®šã®è»Šä¸¡ã§) ---
        {'code': 'MILEAGE_VEHICLE_1000KM', 'name': 'æ„›è»Šã¨1,000kmï¼', 'description': '1å°ã®è»Šä¸¡ã§å®Ÿèµ°è¡Œè·é›¢1,000kmã‚’é”æˆ', 'icon_class': 'fas fa-road', 'category_code': 'vehicle', 'category_name': 'è»Šä¸¡é–¢é€£', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼æ„›è»Šã¨ã®æ—…è·¯ãŒ1,000kmã«ï¼ğŸ›£ï¸ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_FUEL_LOG, 'criteria': {"type": "mileage_vehicle", "value_km": 1000}},
        {'code': 'MILEAGE_VEHICLE_10000KM', 'name': 'æ„›è»Šã¨10,000kmï¼', 'description': '1å°ã®è»Šä¸¡ã§å®Ÿèµ°è¡Œè·é›¢10,000kmã‚’é”æˆ', 'icon_class': 'fas fa-globe-asia', 'category_code': 'vehicle', 'category_name': 'è»Šä¸¡é–¢é€£', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼10,000kmèµ°ç ´ï¼å…±ã«åˆ»ã‚“ã æ­´å²ï¼ğŸŒ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_FUEL_LOG, 'criteria': {"type": "mileage_vehicle", "value_km": 10000}},
        {'code': 'MILEAGE_VEHICLE_100000KM', 'name': 'æ„›è»Šã¨100,000kmï¼', 'description': '1å°ã®è»Šä¸¡ã§å®Ÿèµ°è¡Œè·é›¢100,000kmã‚’é”æˆ', 'icon_class': 'fas fa-rocket', 'category_code': 'vehicle', 'category_name': 'è»Šä¸¡é–¢é€£', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼100,000kmèµ°ç ´ï¼ä¼èª¬ã®ç›¸æ£’ã¨å…±ã«ï¼ğŸš€ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_FUEL_LOG, 'criteria': {"type": "mileage_vehicle", "value_km": 100000}},

        # --- è»Šä¸¡ç™»éŒ²å°æ•°ç³» ---
        {'code': 'VEHICLE_COUNT_3', 'name': 'ãƒã‚¤ã‚¯ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ (3å°)', 'description': 'è»Šä¸¡ã‚’3å°ç™»éŒ²ã™ã‚‹', 'icon_class': 'fas fa-warehouse', 'category_code': 'vehicle', 'category_name': 'è»Šä¸¡é–¢é€£', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼3å°ã®æ„›è»Šï¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å§‹ã¾ã‚Šï¼ã‚¬ãƒ¬ãƒ¼ã‚¸ãŒè¯ã‚„ã‹ã«ï¼ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_VEHICLE, 'criteria': {"type": "vehicle_count", "value": 3}},
        {'code': 'VEHICLE_COUNT_5', 'name': 'ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ˜ãƒƒãƒ‰ (5å°)', 'description': 'è»Šä¸¡ã‚’5å°ç™»éŒ²ã™ã‚‹', 'icon_class': 'fas fa-industry', 'category_code': 'vehicle', 'category_name': 'è»Šä¸¡é–¢é€£', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼5å°ã®ç›¸æ£’ï¼æ°—åˆ†ã¯ã‚‚ã†ã‚ªãƒ¼ãƒŠãƒ¼ã‚ºã‚¯ãƒ©ãƒ–ä»£è¡¨ï¼ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_VEHICLE, 'criteria': {"type": "vehicle_count", "value": 5}},
        {'code': 'VEHICLE_COUNT_10', 'name': 'ãƒã‚¤ã‚¯ç‹ (10å°)', 'description': 'è»Šä¸¡ã‚’10å°ç™»éŒ²ã™ã‚‹', 'icon_class': 'fas fa-crown', 'category_code': 'vehicle', 'category_name': 'è»Šä¸¡é–¢é€£', 'share_text_template': 'å®Ÿç¸¾ã€Œ{achievement_name}ã€è§£é™¤ï¼10å°ã®ãƒã‚¤ã‚¯ã«å›²ã¾ã‚Œã‚‹ã€å¤¢ã®ãƒã‚¤ã‚¯ç‹ï¼ğŸ‘‘ #ã‚‚ã¨ã·ã£ã·ãƒ¼', 'trigger_event_type': EVENT_ADD_VEHICLE, 'criteria': {"type": "vehicle_count", "value": 10}},
    ]
    op.bulk_insert(achievement_definitions_table, new_achievements_data)
    # â–²â–²â–² å®Ÿç¸¾å®šç¾©ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥å‡¦ç†ã“ã“ã¾ã§ â–²â–²â–²


def downgrade():
    # ### commands auto generated by Alembic - START ###
    # with op.batch_alter_table('users', schema=None) as batch_op:
    #     batch_op.alter_column('misskey_user_id',
    #            existing_type=sa.VARCHAR(length=100),
    #            comment=None, # ãƒ€ãƒŸãƒ¼å¤‰æ›´ã‚’æˆ»ã™å‡¦ç†ã¯å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    #            existing_comment='username for miskey',
    #            existing_nullable=False)
    # ### commands auto generated by Alembic - END ###

    # â–¼â–¼â–¼ è¿½åŠ ã—ãŸå®Ÿç¸¾å®šç¾©ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹å‡¦ç† â–¼â–¼â–¼
    achievement_codes_to_delete = [
        'FUEL_LOG_COUNT_10', 'FUEL_LOG_COUNT_50', 'FUEL_LOG_COUNT_100',
        'MAINT_LOG_COUNT_10', 'MAINT_LOG_COUNT_50', 'MAINT_LOG_COUNT_100',
        'NOTE_COUNT_10', 'NOTE_COUNT_50', 'NOTE_COUNT_100',
        'MILEAGE_VEHICLE_1000KM', 'MILEAGE_VEHICLE_10000KM', 'MILEAGE_VEHICLE_100000KM',
        'VEHICLE_COUNT_3', 'VEHICLE_COUNT_5', 'VEHICLE_COUNT_10'
    ]
    # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†åº¦å®šç¾© (downgradeã‚¹ã‚³ãƒ¼ãƒ—ã®ãŸã‚)
    achievement_definitions_table = sa.table(
        'achievement_definitions',
        sa.column('code', sa.String) 
    )
    # INå¥ã‚’ä½¿ã£ã¦ã¾ã¨ã‚ã¦å‰Šé™¤
    # æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã€è¿½åŠ ã—ãŸã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
    bind = op.get_bind()
    stmt = achievement_definitions_table.delete().where(
        achievement_definitions_table.c.code.in_(achievement_codes_to_delete)
    )
    bind.execute(stmt)
    # â–²â–²â–² è¿½åŠ ã—ãŸå®Ÿç¸¾å®šç¾©ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹å‡¦ç† â–²â–²â–²