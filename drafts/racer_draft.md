# 「もとぷっぷー」レーサー/モトクロッサー向け機能 段階的実装計画 詳細仕様

## 1. はじめに

このドキュメントは、Flask Webアプリケーション「もとぷっぷー」において、レーサーやモトクロッサーといった特殊車両の管理機能を追加するための段階的実装計画を詳細に定義するものです。目的は、各開発フェーズにおいて共通の認識と明確な仕様を持ち、効率的かつ整合性の取れた開発を推進することです。

**全体的な開発方針:**

* 競技用車両など、公道走行を前提としない車両（以下、「レーサー車両」）の管理に特化した機能群を、3つのフェーズに分けて段階的に実装します。
* レーサー車両は、走行距離（ODOメーター）ではなく、主に「稼働時間」によってメンテナンスやセッティングを管理します。
* 既存の公道車両向け機能への影響を最小限に抑えつつ、共通化できる部分は最大限活用します。

## 2. 共通の前提条件・制約事項

* **レーサー車両登録後のタイプ変更不可:** 一度「レーサー車両」として登録された車両を、後から「公道車両」へ変更すること、またその逆の変更も、データの整合性を保つため原則としてできません。ユーザーには車両登録時にこの点を明示します。
* **DBマイグレーション:** 各フェーズで必要となるデータベーススキーマの変更は、`Flask-Migrate` (Alembic) を用いて慎重に行い、マイグレーションスクリプトには既存データへの配慮（デフォルト値設定、データ移行処理など）を含めます。
* **テスト:** 各機能追加・変更に伴い、単体テストおよび結合テストを適宜作成・更新し、品質を確保します。

---

## フェーズ1: レーサー車両の定義

### 1. 目的・概要

* アプリケーション内で「レーサー車両」という概念を導入し、公道車両とは異なる管理方法の基礎を築きます。
* レーサー車両は稼働時間で管理されることを前提とし、給油記録や燃費計算の対象外とします。
* このフェーズでは、レーサー車両の登録と基本的な識別、ノート機能の利用のみを可能とし、整備記録機能は将来の拡張（稼働時間入力対応）に備えて利用不可とします。

### 2. 主な機能要件

* **車両登録時の「レーサー」フラグ設定:**
    * 車両登録/編集フォームに「レーサー車両」チェックボックスを設けます。
    * このフラグがONの場合、該当車両はレーサー車両として扱われます。
* **総稼働時間の初期値設定:**
    * 「レーサー車両」として登録する際、「現在の総稼働時間」（例: 中古で購入した場合など）をオプションで入力できるようにします。未入力の場合は0時間とします。
* **レーサー車両の給油記録不可:**
    * 給油記録追加フォームの車両選択肢に、レーサー車両は表示されません。
    * レーサー車両は燃費計算の対象外となります。
* **レーサー車両の整備記録利用不可（本フェーズ限定）:**
    * フェーズ2での整備記録機能拡張（稼働時間入力対応など）との不整合を避けるため、本フェーズではレーサー車両は整備記録の追加・編集・閲覧ができません（UI上で非表示または操作不可とする）。
* **レーサー車両のノート機能は利用可能:**
    * 既存のノート機能は、レーサー車両に対しても通常通り利用可能です。

### 3. DBスキーマ変更案

* **`Motorcycle` モデル (`motorcycles` テーブル):**
    * `is_racer` (Boolean):
        * 用途: 車両がレーサー車両かどうかを識別するフラグ。
        * デフォルト値: `False`
        * NULL許容: `False`
        * 既存データ: マイグレーション時に全既存車両レコードに対し `False` を設定。
    * `total_operating_hours` (Numeric もしくは Float):
        * 用途: レーサー車両の累計総稼働時間を格納。公道車両の場合は原則使用しません（NULLまたは0）。
        * デフォルト値: `0`
        * NULL許容: `True` (公道車両の場合や、レーサーでも初期値未入力の場合を考慮)
        * 既存データ: マイグレーション時に全既存車両レコードに対し `0` または `NULL` を設定。

### 4. UI/UXの主要な変更点・考慮事項

* **車両登録/編集フォーム (`vehicle_form.html` 等):**
    * 「レーサー車両」チェックボックスを追加。
    * 上記チェックボックス選択時に、「現在の総稼働時間」入力フィールドを表示（オプション）。
    * レーサー車両に関する説明文（給油記録不可など）を付記。
* **車両一覧/詳細ページ (`vehicles.html`, 各車両詳細ページ等):**
    * レーサー車両であることを示すアイコンやラベル（例: "[R]", "レーサー"）を表示。
    * レーサー車両の場合、総稼働時間を表示（ODOメーターの代わりに、または併記して）。
* **給油記録関連画面 (`fuel_form.html`, `fuel_log.html` 等):**
    * 給油記録追加フォームの車両選択プルダウンから、`is_racer=True` の車両を除外。
    * 燃費統計等でレーサー車両が計算に含まれないようにする。
* **整備記録関連画面:**
    * レーサー車両を選択している場合、整備記録関連のメニューやボタンを非表示または操作不可にする。

### 5. 主要なロジック・処理フロー

* **車両登録/編集時:**
    * `is_racer` フラグと `total_operating_hours` （レーサー車両の場合）をDBに保存。
* **給油記録追加時:**
    * 車両選択肢を生成する際に、`current_user` が所有する車両のうち `is_racer=False` のもののみをリストアップ。
* **各種表示時:**
    * 車両情報取得時に `is_racer` フラグを参照し、表示内容や操作可否を制御。

### 6. 既存機能への影響と注意点

* 既存の公道車両の動作には影響を与えないようにします。
* 給油記録機能は、レーサー車両を明確に除外することで、既存ロジックへの影響を限定的にします。

### 7. このフェーズで実装しないこと（スコープ外）

* レーサー車両に対する稼働時間ベースの整備記録機能の実装。
* セッティング記録機能の実装。
* 重要コンポーネントのライフサイクル管理機能の実装。
* 稼働時間の自動更新ロジック（整備記録時や走行ログからの更新など）。

### 8. 次のフェーズへの繋がり・前提条件

* 本フェーズで導入された `Motorcycle.is_racer` フラグおよび `Motorcycle.total_operating_hours` カラムは、フェーズ2以降のレーサー車両向け機能開発の基礎となります。
* レーサー車両が明確に区別されることで、フェーズ2で整備記録フォームの表示や入力項目を安全に切り替えることが可能になります。

---

## フェーズ2: 整備記録の拡張

### 1. 目的・概要

* レーサー車両に対しても整備記録機能を提供可能にします。
* 整備記録フォームを拡張し、「通常の整備記録」と「セッティング記録」の2種類の記録を同じ枠組みで入力・管理できるようにします。
* レーサー車両の整備記録では、従来のODOメーター入力の代わりに「総稼働時間」を入力するようにします。

### 2. 主な機能要件

* **整備記録フォームの記録タイプ切り替え:**
    * 整備記録追加/編集フォーム内に、「記録タイプ」を選択する手段（例: ラジオボタン、ドロップダウン）を設けます。
    * 選択肢: 「整備記録」「セッティング記録」。
* **「セッティング記録」機能:**
    * 記録タイプで「セッティング記録」を選択した場合、専用の入力フォームが表示されます。
    * 記録項目は、以前の議論で提案された「詳細セッティング管理機能」の内容に準じます（サスペンション各部、タイヤ情報、エンジン/駆動系セッティング、ジオメトリ、走行コンディション等）。これらの詳細はJSON形式でDBに格納します。
* **レーサー車両の整備記録における「総稼働時間」入力:**
    * 記録対象の車両がレーサー車両の場合、記録タイプが「整備記録」「セッティング記録」のいずれであっても、従来のODOメーター入力フィールドの代わりに「その整備/セッティング時点での総稼働時間」入力フィールドを表示し、必須入力とします。
    * この値は、`Motorcycle.total_operating_hours` を更新する基準となります（通常、前回記録時からの差分ではなく、その時点での累積総稼働時間を入力）。
* **公道車両の整備記録における「ODOメーター」入力:**
    * 記録対象の車両が公道車両の場合、従来通りODOメーター値を入力します（こちらは変更なし）。

### 3. DBスキーマ変更案

* **`MaintenanceEntry` モデル (`maintenance_entries` テーブル):**
    * `record_type` (String):
        * 用途: 記録の種類を識別（'maintenance' または 'setting'）。
        * デフォルト値: `'maintenance'`
        * NULL許容: `False`
        * 既存データ: マイグレーション時に全既存レコードに対し `'maintenance'` を設定。
    * `setting_details` (JSONB):
        * 用途: 「セッティング記録」の場合の詳細情報をJSON形式で格納。キー・バリュー形式で柔軟にセッティング項目を保存。
        * NULL許容: `True` ('maintenance' の場合はNULL)
        * 既存データ: マイグレーション時に全既存レコードに対し `NULL` を設定。
    * `operating_hours_at_event` (Numeric もしくは Float):
        * 用途: レーサー車両の場合の、整備/セッティング時点での車両の総稼働時間。
        * NULL許容: `True` (公道車両の場合はNULL)
        * 既存データ: マイグレーション時に全既存レコードに対し `NULL` を設定。
    * 既存の `odometer` (または `total_distance_at_maintenance`) カラム:
        * 公道車両のODOメーター値を格納する役割は変更なし。レーサー車両の整備記録ではNULLとなります。

### 4. UI/UXの主要な変更点・考慮事項

* **整備記録追加/編集フォーム (`maintenance_form.html` 等):**
    * 車両選択後、`is_racer` フラグに応じて「ODOメーター」入力欄と「総稼働時間」入力欄をJavaScriptで動的に表示/非表示、及び必須属性を制御。
    * 「記録タイプ」選択（ラジオボタン等）を設置。
    * 「記録タイプ」の選択に応じて、表示されるフォーム項目群をJavaScriptで動的に大幅に切り替え。
        * 「整備記録」選択時: 従来の整備項目（作業内容、費用、部品など）。
        * 「セッティング記録」選択時: サスペンション（フロント/リア各詳細）、タイヤ（メーカー、モデル、空気圧等）、エンジン/駆動系（スプロケ丁数、ECUマップ名等）、ジオメトリ、走行コンディション（天候、路面状況、気温等）、ライダーコメント等の専用入力フィールド群を表示。これらは分かりやすくグループ化する。
* **整備記録一覧/詳細ページ (`maintenance_log.html` 等):**
    * 一覧に「記録タイプ」（整備/セッティング）を表示。
    * 詳細表示時、「セッティング記録」の場合はその詳細情報を整形して表示。
    * レーサー車両の記録には「総稼働時間」を、公道車両の記録には「ODOメーター値」を適切に表示。

### 5. 主要なロジック・処理フロー

* **フォーム表示時:**
    * 選択された車両の `is_racer` フラグに基づき、ODO/稼働時間入力フィールドを制御。
    * 選択された `record_type` に基づき、表示するフォームセクションを制御。
* **フォーム送信時:**
    * 車両タイプ（レーサー/公道）に応じて、`operating_hours_at_event` または `odometer` の値を保存。
    * `record_type` が 'setting' の場合、`setting_details` にフォーム入力値をJSONとして整形して保存。
    * レーサー車両の整備記録（整備・セッティング両方）が保存された際、入力された `operating_hours_at_event` の値で、関連する `Motorcycle.total_operating_hours` を更新（通常は最新の記録値で上書き、または入力値が現在の値より大きければ更新）。
* **セッティング詳細情報の扱い:**
    * `setting_details` (JSONB) に格納するキー名はあらかじめ規約を決めておき、登録・表示時に利用。

### 6. 既存機能への影響と注意点

* 既存の公道車両の整備記録機能は、入力項目や保存データに変更がないように見えつつ、内部的には `record_type` が 'maintenance' として扱われるようになります。表示上はこれまで通りの体験を維持します。
* DBマイグレーション時に、既存の整備記録データに新しいカラムのデフォルト値が正しく設定されることを確認します。

### 7. このフェーズで実装しないこと（スコープ外）

* 重要コンポーネントのライフサイクル管理機能。
* セッティングテンプレートの呼び出し機能（ただし、UI設計時には将来的な拡張を意識）。
* セッティング記録に基づく高度な分析や比較機能。

### 8. 次のフェーズへの繋がり・前提条件

* 本フェーズで記録されるようになるレーサー車両の「総稼働時間」 (`operating_hours_at_event`) および `Motorcycle.total_operating_hours` は、フェーズ3の「重要コンポーネントのライフサイクル管理」における使用量計算の基礎データとなります。
* 「セッティング記録」の詳細データは、将来的に特定の条件下での最適なセッティングを見つけ出すための分析機能などに活用できる可能性があります。

---

## フェーズ3: 重要コンポーネントのライフサイクル管理機能の実装

### 1. 目的・概要

* レーサー車両（および希望するなら公道車両も）の重要コンポーネント（エンジン部品、タイヤ、オイル等）について、使用状況（稼働時間、距離、期間など）を追跡し、メンテナンスや交換の適切なタイミングをユーザーに通知する仕組みを構築します。
* 既存の「メンテナンスリマインダー機能」と連携し、自動的な通知を実現します。

### 2. 主な機能要件

* **ライフサイクル管理対象部品の登録・設定:**
    * ユーザーは、車両ごとにライフサイクルを管理したい部品（コンポーネント）を定義できます（例: "ピストン", "エンジンオイル", "フロントタイヤ", "ブレーキパッド"）。
    * 各部品に対し、管理単位（例: "時間", "km", "日数", "セッション回数"）、交換/メンテナンス推奨の閾値、現在の累積使用量を設定/表示します。
* **整備記録との連動による使用量リセット・更新:**
    * 整備記録で特定の管理対象部品の「交換」や「オーバーホール」を記録した際、該当部品のライフサイクルにおける「現在の累積使用量」をリセットし、「最終メンテナンス日/時/距離」を更新するオプションを提供します。
* **稼働時間/ODOに基づく使用量の自動計算・累積:**
    * 車両の総稼働時間 (`Motorcycle.total_operating_hours`) または総走行距離 (`Motorcycle.odometer`) が更新されるたび（主に整備記録入力時）、関連付けられた各ライフサイクル管理部品の「現在の累積使用量」を自動的に加算更新します。
    * （例: 前回のオイル交換時の総稼働時間が50時間、今回の整備記録時の総稼働時間が60時間なら、オイルの累積使用時間に10時間が加算される。）
* **閾値到達時のリマインダー通知:**
    * 各ライフサイクル管理部品の「現在の累積使用量」が設定された「閾値」に近づいた場合（例: 80%到達時）、または超過した場合に、既存のメンテナンスリマインダー機能と連携してユーザーに通知します。

### 3. DBスキーマ変更案

* **新モデル `TrackedComponent` (`tracked_components` テーブル):**
    * `id` (Integer, Primary Key)
    * `motorcycle_id` (Integer, ForeignKey to `motorcycles.id`, nullable=False)
    * `user_id` (Integer, ForeignKey to `users.id`, nullable=False)
    * `component_name` (String, nullable=False, 例: "ピストンキット")
    * `management_unit` (String, nullable=False, 例: "hours", "km", "days", "sessions")
    * `threshold_value` (Numeric もしくは Integer, nullable=False, 例: 100 (時間), 5000 (km))
    * `current_value` (Numeric もしくは Integer, default=0, nullable=False)
    * `last_maintained_date` (Date, nullable=True): 最後にこの部品を交換/OHした日付。
    * `last_maintained_at_hours` (Numeric, nullable=True): 最終メンテナンス時の車両総稼働時間 (レーサー車両の場合)。
    * `last_maintained_at_odo` (Integer, nullable=True): 最終メンテナンス時の車両ODO (公道車両の場合)。
    * `reminder_enabled` (Boolean, default=True, nullable=False)
    * `notes` (Text, nullable=True)
    * `created_at` (DateTime, default=func.now())
    * `updated_at` (DateTime, default=func.now(), onupdate=func.now())
* **`MaintenanceEntry` モデルへの関連付け (任意):**
    * 直接的なFKは必須ではないかもしれませんが、整備記録がどの `TrackedComponent` のリセットトリガーになったかを記録したい場合は、中間テーブルや `MaintenanceEntry` に `reset_tracked_component_id` (FK, nullable=True)のようなカラムを検討できます。ただし、まずはシンプルにロジックで対応し、必要に応じて追加する方向でも良いでしょう。
* **`Reminder` モデル (`reminders` テーブル) との連携:**
    * ライフサイクル管理によって生成されるリマインダーであることを示す情報（例: `source_type='lifecycle'`, `source_id=TrackedComponent.id`）をリマインダーに持たせるか、既存のリマインダーの仕組みにうまく乗せる方法を検討します。

### 4. UI/UXの主要な変更点・考慮事項

* **ライフサイクル管理部品の設定画面:**
    * 車両詳細ページ内、または専用の管理ページで、その車両に紐づく `TrackedComponent` の一覧表示、新規追加、編集、削除を行うUIを提供。
    * 部品名、管理単位、閾値などを入力。
* **整備記録フォームへの関連付けUI:**
    * 整備記録で部品交換を記録する際、関連する `TrackedComponent` を選択し、「この部品のライフサイクルをリセットする」というチェックボックスやボタンを設置。
* **ダッシュボード等での警告表示:**
    * 閾値に近づいている、または超過しているライフサイクル管理部品がある場合、ダッシュボードや車両詳細ページで警告やサマリーを表示。
* **リマインダー表示:**
    * 既存のリマインダー一覧に、ライフサイクル管理起因のリマインダーも統合して表示。内容は部品名、交換推奨時期、現在の状況などが分かるように。

### 5. 主要なロジック・処理フロー

* **`TrackedComponent` のCRUD処理:**
    * ユーザーが部品を登録・編集・削除するロジック。
* **累積使用量の計算・更新ロジック:**
    * 整備記録が追加/編集され、`Motorcycle.total_operating_hours` (レーサー) または `Motorcycle.odometer` (公道車) が更新された際にトリガー。
    * 該当車両に紐づく全ての `TrackedComponent` について、前回の `last_maintained_at_hours/odo` と現在の車両総稼働時間/ODOの差分を計算。
    * その差分を `TrackedComponent.current_value` に加算（管理単位が時間/距離の場合）。
    * （注意：この計算は、部品が実際に使用された期間のみを対象とするため、`last_maintained_date` から現在までの単純な時間経過とは異なる点に留意。）
* **ライフサイクルリセット処理:**
    * 整備記録で「ライフサイクルをリセット」が指示された場合、該当する `TrackedComponent` の `current_value` を0にリセットし、`last_maintained_date` を整備記録の日付に、`last_maintained_at_hours/odo` をその時点の車両総稼働時間/ODOに更新。
* **リマインダー生成・連携ロジック:**
    * `TrackedComponent.current_value` が更新されるたび、または定期的なバッチ処理で、`threshold_value` との比較を行う。
    * 設定された条件（例: 閾値の80%以上）を満たした場合、`Reminder` テーブルに新しいリマインダーレコードを作成、または既存リマインダーを更新。
    * リマインダーには、どの車両のどの部品に関するものか、推奨アクションなどの情報を含める。

### 6. 既存機能への影響と注意点

* **メンテナンスリマインダー機能:** 既存の手動リマインダーと、ライフサイクル管理による自動生成リマインダーが共存できるように、リマインダーの種別や表示方法を整理する必要があるかもしれません。
* **パフォーマンス:** 車両の稼働時間/ODOが更新されるたびに多数の部品のライフサイクルを再計算する処理は、部品数が多い場合に負荷となる可能性があります。特にリアルタイム更新ではなく、整備記録保存時などの特定タイミングに限定する、効率的なクエリを使用するなどの配慮が必要です。
* **初期データ設定:** 既存ユーザーがこの機能を利用開始する際、管理したい部品の「現在の累積使用量」や「最終メンテナンス情報」をどのように初期設定させるか、UI/UX上の配慮が必要です。

### 7. このフェーズで実装しないこと（スコープ外）

* ユーザーが管理単位（例: "セッション回数"）を完全に自由に定義・計算ロジックを組み込む機能。初期はプリセットされた単位（時間、km、日数）から選択する形が現実的。
* ライフサイクルデータに基づく高度な統計分析やコスト予測機能。
* 部品の在庫管理機能。

### 8. 次のフェーズへの繋がり・前提条件

* 本フェーズで実装されるライフサイクル管理機能は、「もとぷっぷー」のレーサー車両管理における中核的な価値の一つとなります。
* 蓄積されたライフサイクルデータやメンテナンス履歴は、将来的により高度なメンテナンス予測、部品ごとのコスト分析、さらには特定の走行条件下での部品寿命の統計的分析といった機能拡張への道を開きます。
