{# motopuppu/templates/note_form.html #}
{% extends "base.html" %}

{# ページタイトルを動的に設定 #}
{% set page_title = "メモの追加" if form_action == 'add' else "メモの編集" %}
{% block title %}{{ page_title }} - もとぷっぷー{% endblock %}

{% block content %}
<h2>{{ page_title }}</h2>
{# 編集時には関連車両名も表示（任意） #}
{% if form_action == 'edit' and entry.motorcycle %}
    <h4 class="text-muted mb-4">関連車両: {{ entry.motorcycle.name }}</h4>
{% endif %}

{# --- フラッシュメッセージ表示 --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}
{# --- フラッシュメッセージ表示 ここまで --- #}

{# 送信先URLとHTTPメソッドを設定 #}
<form method="POST" action="{{ url_for('notes.add_note') if form_action == 'add' else url_for('notes.edit_note', note_id=entry.id if entry else 0) }}"> {# edit時はnote_idが必要 #}
    {# CSRFトークン用プレースホルダー (Flask-WTF導入時) #}
    {# {{ form.hidden_tag() }} #}

    {# 関連車両選択 (任意) #}
    <div class="mb-3">
        <label for="motorcycle_id" class="form-label">関連車両 (任意)</label>
        <select class="form-select" id="motorcycle_id" name="motorcycle_id">
            {# 「紐付けない」オプション #}
            {# entryがない(新規) or entryにmotorcycle_idがない(辞書orオブジェクト)場合に選択状態 #}
            <option value="" {% if not entry or (entry is mapping and not entry.get('motorcycle_id')) or (entry and not entry is mapping and not entry.motorcycle_id) %}selected{% endif %}>-- 車両に紐付けない --</option>
            {# ユーザーの車両リストをループ #}
            {% for motorcycle in motorcycles %}
                {# 現在選択されているIDを取得 (オブジェクトか辞書かで分岐) #}
                {% set selected_id = entry.get('motorcycle_id') | int(0) if entry is mapping else (entry.motorcycle_id if entry else 0) %}
                <option value="{{ motorcycle.id }}" {% if selected_id == motorcycle.id %}selected{% endif %}>
                    {{ motorcycle.name }}
                </option>
            {% endfor %}
        </select>
        <div class="form-text">このメモを特定の車両に関連付ける場合に選択します。</div>
    </div>

    {# メモの日付 (必須) #}
    <div class="mb-3">
        <label for="note_date" class="form-label">日付 <span class="text-danger">*</span></label>
        {# 値設定ロジック (オブジェクトか辞書かを判定) #}
        {% set date_value = today_iso %} {# today_iso はビュー関数から渡す想定 #}
        {% if entry %}
            {% if entry is mapping %}
                {% set date_value = entry.get('note_date', today_iso) %}
            {% elif entry.note_date %}
                {% set date_value = entry.note_date.isoformat() %}
            {% endif %}
        {% endif %}
        <input type="date" class="form-control" id="note_date" name="note_date" value="{{ date_value }}" required>
    </div>

    {# タイトル (任意) #}
    <div class="mb-3">
        <label for="title" class="form-label">タイトル (任意)</label>
        {# 値設定ロジック (オブジェクトか辞書かを判定) #}
        <input type="text" class="form-control" id="title" name="title" maxlength="150"
               value="{{ entry.get('title') if entry is mapping else (entry.title if entry else '') }}">
    </div>

    {# メモ内容 (必須) #}
    <div class="mb-3">
        <label for="content" class="form-label">メモ内容 <span class="text-danger">*</span></label>
        {# 値設定ロジック (オブジェクトか辞書かを判定) #}
        <textarea class="form-control" id="content" name="content" rows="8" required maxlength="2000">{{ entry.get('content') if entry is mapping else (entry.content if entry else '') }}</textarea> {# rowsを少し増やす #}
        <div class="form-text">メモの内容を入力します (最大2000文字)。</div>
    </div>

    {# 送信・キャンセルボタン #}
    <div class="mt-4">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> {{ 'メモを追加' if form_action == 'add' else '更新する' }}
        </button>
        {# キャンセル時はメモ一覧画面へ #}
        <a href="{{ url_for('notes.notes_log') }}" class="btn btn-secondary">
            <i class="fas fa-times me-1"></i> キャンセル
        </a>
    </div>

</form>
{% endblock %}