{# motopuppu/templates/note_form.html #}
{% extends "base.html" %}

{% set page_title = "ノートの追加" if form_action == 'add' else "ノートの編集" %}
{% block title %}{{ page_title }} - もとぷっぷー{% endblock %}

{% block content %}
<h2>{{ page_title }}</h2>
{% if form_action == 'edit' and entry.motorcycle %}
    <h4 class="text-muted mb-4">関連車両: {{ entry.motorcycle.name }}</h4>
{% endif %}

{# --- Flash Messages (変更なし) --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{# --- Form (変更なし) --- #}
<form method="POST" id="note-form" action="{{ url_for('notes.add_note') if form_action == 'add' else url_for('notes.edit_note', note_id=entry.id if entry else 0) }}">
    {# CSRF Token placeholder #}

    {# 関連車両選択 (変更なし) #}
    <div class="mb-3">
        <label for="motorcycle_id" class="form-label">関連車両 (任意)</label>
        <select class="form-select" id="motorcycle_id" name="motorcycle_id">
            <option value="" {% if not entry or (entry is mapping and not entry.get('motorcycle_id')) or (entry and not entry is mapping and not entry.motorcycle_id) %}selected{% endif %}>-- 車両に紐付けない --</option>
            {% for motorcycle in motorcycles %}
                {% set selected_id = entry.get('motorcycle_id') | int(0) if entry is mapping else (entry.motorcycle_id if entry else 0) %}
                <option value="{{ motorcycle.id }}" {% if selected_id == motorcycle.id %}selected{% endif %}>
                    {{ motorcycle.name }}
                </option>
            {% endfor %}
        </select>
        <div class="form-text">このノートを特定の車両に関連付ける場合に選択します。</div>
    </div>

    {# 日付 (変更なし) #}
    <div class="mb-3">
        <label for="note_date" class="form-label">日付 <span class="text-danger">*</span></label>
        {% set date_value = today_iso %}
        {% if entry %}
            {% if entry is mapping %} {% set date_value = entry.get('note_date', today_iso) %}
            {% elif entry.note_date %} {% set date_value = entry.note_date.isoformat() %}
            {% endif %}
        {% endif %}
        <input type="date" class="form-control" id="note_date" name="note_date" value="{{ date_value }}" required>
    </div>

    {# カテゴリー選択 (変更なし) #}
    <div class="mb-3">
        <label class="form-label">カテゴリー <span class="text-danger">*</span></label>
        <div>
            {% set current_category = entry.get('category') if entry is mapping else (entry.category if entry else 'note') %}
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="category" id="category-note" value="note" {% if current_category == 'note' %}checked{% endif %} required>
                <label class="form-check-label" for="category-note">
                    <i class="fas fa-sticky-note me-1"></i> ノート
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="category" id="category-task" value="task" {% if current_category == 'task' %}checked{% endif %} required>
                <label class="form-check-label" for="category-task">
                    <i class="fas fa-tasks me-1"></i> タスク (TODOリスト)
                </label>
            </div>
        </div>
    </div>

    {# タイトル (変更なし) #}
    <div class="mb-3">
        <label for="title" class="form-label">タイトル (任意)</label>
        <input type="text" class="form-control" id="title" name="title" maxlength="150"
               value="{{ entry.get('title') if entry is mapping else (entry.title if entry else '') }}">
    </div>

    {# --- ▼▼▼ 内容欄にID追加 ▼▼▼ --- #}
    <div class="mb-3" id="content-section"> {# IDを追加 #}
        <label for="content" class="form-label">ノート内容 <span class="text-danger">*</span></label>
        <textarea class="form-control" id="content" name="content" rows="8" required maxlength="2000">{{ entry.get('content') if entry is mapping else (entry.content if entry else '') }}</textarea>
        <div class="form-text">ノートの内容を入力します (最大2000文字)。</div>
    </div>
    {# --- ▲▲▲ 内容欄ここまで ▲▲▲ --- #}

    {# TODOリスト入力欄 (変更なし) #}
    <div id="todo-list-section" class="mb-3 border p-3 rounded" style="display: none;">
        <h5><i class="fas fa-list-check me-1"></i> TODOリスト</h5>
        <div id="todo-items-container">
            {# JavaScriptでここにTODOアイテム入力欄が追加される #}
        </div>
        <button type="button" id="add-todo-item" class="btn btn-sm btn-outline-success mt-2">
            <i class="fas fa-plus me-1"></i> アイテムを追加
        </button>
        <div class="form-text mt-1">各アイテムは100文字以内。最大50アイテムまで追加できます。</div>
    </div>

    {# Submit/Cancel Buttons (変更なし) #}
    <div class="mt-4">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> {{ 'ノートを追加' if form_action == 'add' else '更新する' }}
        </button>
        <a href="{{ url_for('notes.notes_log') }}" class="btn btn-secondary">
            <i class="fas fa-times me-1"></i> キャンセル
        </a>
    </div>

</form>

{# --- ▼▼▼ TODOアイテムのテンプレート修正 ▼▼▼ --- #}
<template id="todo-item-template">
    <div class="input-group mb-2 todo-item">
        <div class="input-group-text">
            {# チェックボックス本体: nameは動的に変更, value='true'固定 #}
            <input class="form-check-input mt-0 todo-item-check" type="checkbox" value="true" aria-label="Checkbox for following text input">
             {# Hidden Input: デフォルトで'false'を送信する役割. nameは動的に変更 #}
            <input type="hidden" value="false" name="todo_checked[]">
        </div>
        {# テキスト入力: name="todo_text[]" は変更なし #}
        <input type="text" class="form-control todo-item-text" name="todo_text[]" placeholder="タスク内容 (必須)" required maxlength="100" aria-label="Text input with checkbox">
        <button type="button" class="btn btn-outline-danger remove-todo-item" title="このアイテムを削除">
            <i class="fas fa-trash-alt"></i>
        </button>
    </div>
</template>
{# --- ▲▲▲ TODOアイテムのテンプレート修正ここまで ▲▲▲ --- #}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoryRadios = document.querySelectorAll('input[name="category"]');
    const todoListSection = document.getElementById('todo-list-section');
    const todoItemsContainer = document.getElementById('todo-items-container');
    const addTodoItemButton = document.getElementById('add-todo-item');
    const todoItemTemplate = document.getElementById('todo-item-template');
    const noteForm = document.getElementById('note-form');
    // --- ▼▼▼ 内容セクションの要素を取得 ▼▼▼ ---
    const contentSection = document.getElementById('content-section');
    const contentTextarea = document.getElementById('content'); // textareaも取得
    // --- ▲▲▲ 内容セクションの要素を取得ここまで ▲▲▲ ---
    const MAX_TODO_ITEMS = 50;

    // --- ▼▼▼ カテゴリー変更時の表示切り替え (内容欄も追加) ▼▼▼ ---
    function toggleSections() {
        const selectedCategory = document.querySelector('input[name="category"]:checked').value;
        if (selectedCategory === 'task') {
            todoListSection.style.display = 'block';
            contentSection.style.display = 'none'; // 内容欄を非表示
            // contentTextarea.required = false; // required属性も解除 (任意)
        } else { // 'note' の場合
            todoListSection.style.display = 'none';
            contentSection.style.display = 'block'; // 内容欄を表示
            // contentTextarea.required = true; // required属性を戻す (任意)
        }
        updateAddButtonState();
    }
    // --- ▲▲▲ カテゴリー変更時の表示切り替えここまで ▲▲▲ ---

    categoryRadios.forEach(radio => {
        // --- ▼▼▼ イベントリスナーを toggleSections に変更 ▼▼▼ ---
        radio.addEventListener('change', toggleSections);
        // --- ▲▲▲ イベントリスナー変更ここまで ▲▲▲ ---
    });

    // --- ▼▼▼ TODOアイテム追加処理 (完了スタイル適用追加) ▼▼▼ ---
    function addTodoItem(text = '', checked = false) {
        if (todoItemsContainer.children.length >= MAX_TODO_ITEMS) {
            alert(`TODOアイテムは最大${MAX_TODO_ITEMS}個までです。`);
            return;
        }

        const templateContent = todoItemTemplate.content.cloneNode(true);
        const newItem = templateContent.querySelector('.todo-item'); // アイテム全体(div)
        const checkbox = newItem.querySelector('.todo-item-check');
        const textInput = newItem.querySelector('.todo-item-text');
        const removeButton = newItem.querySelector('.remove-todo-item');
        const hiddenInput = newItem.querySelector('input[type="hidden"]'); // Hidden input を取得

        textInput.value = text;
        checkbox.checked = checked;

        // チェック状態に応じて name 属性を制御する関数 (変更なし)
        function updateCheckboxNames() {
            if (checkbox.checked) {
                checkbox.name = 'todo_checked[]';
                hiddenInput.name = '';
            } else {
                checkbox.name = '';
                hiddenInput.name = 'todo_checked[]';
            }
        }

        // --- ▼▼▼ 完了スタイルを適用/解除する関数 ▼▼▼ ---
        function applyDoneStyle() {
             if (checkbox.checked) {
                 newItem.classList.add('todo-item-done'); // 親要素にクラスを追加
             } else {
                 newItem.classList.remove('todo-item-done'); // 親要素からクラスを削除
             }
        }
        // --- ▲▲▲ 完了スタイル適用関数ここまで ▲▲▲ ---

        // チェックボックス変更時のイベントリスナー
        checkbox.addEventListener('change', function() {
            updateCheckboxNames();
            applyDoneStyle(); // ★★★ スタイル適用/解除を呼び出し ★★★
        });

        // 初期状態の name 属性を設定
        updateCheckboxNames();
        // --- ▼▼▼ 初期状態のスタイル適用 ▼▼▼ ---
        applyDoneStyle(); // ★★★ 初期スタイル適用を追加 ★★★
        // --- ▲▲▲ 初期状態のスタイル適用ここまで ▲▲▲ ---

        // 削除ボタンの処理 (変更なし)
        removeButton.addEventListener('click', function() {
            newItem.remove();
            updateAddButtonState();
        });

        todoItemsContainer.appendChild(newItem);
        updateAddButtonState();
    }
    // --- ▲▲▲ TODOアイテム追加処理ここまで ▲▲▲ ---

    addTodoItemButton.addEventListener('click', function() {
        addTodoItem();
    });

    // アイテム追加ボタンの有効/無効状態更新 (変更なし)
    function updateAddButtonState() {
        if (todoItemsContainer.children.length >= MAX_TODO_ITEMS) {
            addTodoItemButton.disabled = true;
            addTodoItemButton.title = `最大${MAX_TODO_ITEMS}個までです`;
        } else {
            addTodoItemButton.disabled = false;
            addTodoItemButton.title = '';
        }
        const selectedCategory = document.querySelector('input[name="category"]:checked')?.value;
        if (selectedCategory !== 'task') {
            addTodoItemButton.disabled = true;
        }
    }

    // --- 編集時の初期データ読み込み (変更なし) ---
    const existingTodosJson = {{ entry.todos | tojson | safe if entry and entry.todos else 'null' }};
    if (existingTodosJson && Array.isArray(existingTodosJson)) {
        existingTodosJson.forEach(item => {
            if (item && typeof item.text === 'string') {
                 addTodoItem(item.text, item.checked || false);
            }
        });
    }

    // フォーム送信前のバリデーション (変更なし)
    noteForm.addEventListener('submit', function(event) {
        const selectedCategory = document.querySelector('input[name="category"]:checked').value;
        if (selectedCategory === 'task') {
            const todoItems = todoItemsContainer.querySelectorAll('.todo-item');
            if (todoItems.length > MAX_TODO_ITEMS) {
                alert(`TODOアイテムは最大${MAX_TODO_ITEMS}個までです。`);
                event.preventDefault();
                return;
            }
            let hasEmptyText = false;
            todoItems.forEach(item => {
                const textInput = item.querySelector('.todo-item-text');
                if (!textInput.value.trim()) {
                    hasEmptyText = true;
                    textInput.classList.add('is-invalid');
                } else {
                    textInput.classList.remove('is-invalid');
                }
            });
            if (hasEmptyText) {
                alert('タスク内容が入力されていないアイテムがあります。');
                event.preventDefault();
            }
        }
    });

    // --- ▼▼▼ 初期表示処理を toggleSections に変更 ▼▼▼ ---
    toggleSections(); // ページ読み込み時にカテゴリに応じて関連セクションの表示を切り替え
    // --- ▲▲▲ 初期表示処理変更ここまで ▲▲▲ ---

});
</script>
{% endblock %}