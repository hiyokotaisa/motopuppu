{# motopuppu/templates/note_form.html #}
{% extends "base.html" %}

{# ▼▼▼ ページタイトル変更 ▼▼▼ #}
{% set page_title = "ノートの追加" if form_action == 'add' else "ノートの編集" %}
{% block title %}{{ page_title }} - もとぷっぷー{% endblock %}

{% block content %}
<h2>{{ page_title }}</h2> {# 見出しも page_title を使うので自動で変更 #}
{% if form_action == 'edit' and entry.motorcycle %}
    <h4 class="text-muted mb-4">関連車両: {{ entry.motorcycle.name }}</h4>
{% endif %}

{# --- Flash Messages --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{# --- Form --- #}
<form method="POST" action="{{ url_for('notes.add_note') if form_action == 'add' else url_for('notes.edit_note', note_id=entry.id if entry else 0) }}"> {# url_for は notes のまま #}
    {# CSRF Token placeholder #}

    {# 関連車両選択 #}
    <div class="mb-3">
        <label for="motorcycle_id" class="form-label">関連車両 (任意)</label>
        <select class="form-select" id="motorcycle_id" name="motorcycle_id">
            <option value="" {% if not entry or (entry is mapping and not entry.get('motorcycle_id')) or (entry and not entry is mapping and not entry.motorcycle_id) %}selected{% endif %}>-- 車両に紐付けない --</option>
            {% for motorcycle in motorcycles %}
                {% set selected_id = entry.get('motorcycle_id') | int(0) if entry is mapping else (entry.motorcycle_id if entry else 0) %}
                <option value="{{ motorcycle.id }}" {% if selected_id == motorcycle.id %}selected{% endif %}>
                    {{ motorcycle.name }}
                </option>
            {% endfor %}
        </select>
        {# ▼▼▼ ヘルプテキスト変更 ▼▼▼ #}
        <div class="form-text">このノートを特定の車両に関連付ける場合に選択します。</div>
    </div>

    {# 日付 #}
    <div class="mb-3">
        <label for="note_date" class="form-label">日付 <span class="text-danger">*</span></label>
        {% set date_value = today_iso %}
        {% if entry %}
            {% if entry is mapping %} {% set date_value = entry.get('note_date', today_iso) %}
            {% elif entry.note_date %} {% set date_value = entry.note_date.isoformat() %}
            {% endif %}
        {% endif %}
        <input type="date" class="form-control" id="note_date" name="note_date" value="{{ date_value }}" required>
    </div>

    {# タイトル #}
    <div class="mb-3">
        <label for="title" class="form-label">タイトル (任意)</label>
        <input type="text" class="form-control" id="title" name="title" maxlength="150"
               value="{{ entry.get('title') if entry is mapping else (entry.title if entry else '') }}">
    </div>

    {# 内容 #}
    <div class="mb-3">
        {# ▼▼▼ ラベルとヘルプテキスト変更 ▼▼▼ #}
        <label for="content" class="form-label">ノート内容 <span class="text-danger">*</span></label>
        <textarea class="form-control" id="content" name="content" rows="8" required maxlength="2000">{{ entry.get('content') if entry is mapping else (entry.content if entry else '') }}</textarea>
        <div class="form-text">ノートの内容を入力します (最大2000文字)。</div>
    </div>

    {# Submit/Cancel Buttons #}
    <div class="mt-4">
        <button type="submit" class="btn btn-primary">
            {# ▼▼▼ ボタンテキスト変更 ▼▼▼ #}
            <i class="fas fa-save me-1"></i> {{ 'ノートを追加' if form_action == 'add' else '更新する' }}
        </button>
        <a href="{{ url_for('notes.notes_log') }}" class="btn btn-secondary"> {# url_for は notes のまま #}
            <i class="fas fa-times me-1"></i> キャンセル
        </a>
    </div>

</form>
{% endblock %}