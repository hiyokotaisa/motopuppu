{# motopuppu/templates/team/team_dashboard.html #}
{% extends "base.html" %}

{% block title %}Team: {{ team.name }} - もとぷっぷー{% endblock %}

{% block content %}
{% include '_breadcrumbs.html' %}

<style>
    /* --- チームダッシュボード専用スタイル --- */
    .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .hover-lift:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.08) !important; }

    .hero-stat-card { border: none; border-radius: 1rem; background-color: #fff; }
    .hero-stat-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.5rem; }

    .section-card { border: none; border-radius: 1rem; background-color: #fff; overflow: hidden; }
    .section-header { background-color: transparent; border-bottom: 1px solid #f0f0f0; padding: 1.25rem 1.5rem; }
    
    .avatar-stack { display: flex; }
    .avatar-stack img { border: 2px solid #fff; margin-left: -10px; transition: transform 0.2s; }
    .avatar-stack img:first-child { margin-left: 0; }
    .avatar-stack img:hover { transform: translateY(-3px); z-index: 2; }

    .event-date-badge {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 60px; height: 60px; border-radius: 10px; background-color: #f8f9fa; color: #495057;
        border: 1px solid #e9ecef;
    }
    .event-date-month { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
    .event-date-day { font-size: 1.5rem; font-weight: bold; line-height: 1; }

    /* ランキングメダル */
    .medal-icon { font-size: 1.2rem; width: 24px; text-align: center; margin-right: 8px; }
    .medal-gold { color: #ffc107; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .medal-silver { color: #adb5bd; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .medal-bronze { color: #cd7f32; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
</style>

{# ヘッダーエリア #}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-0 text-dark"><i class="fas fa-users me-2 text-primary"></i>{{ team.name }}</h2>
        <p class="text-muted mb-0">Team Dashboard</p>
    </div>
    <div>
        {% if team.owner_id == current_user.id %}
        <a href="{{ url_for('team.manage_team', team_id=team.id) }}" class="btn btn-outline-dark btn-sm">
            <i class="fas fa-cog me-1"></i> 設定
        </a>
        {% endif %}
        
        {% if team.owner_id != current_user.id %}
        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#leaveTeamModal">
            <i class="fas fa-sign-out-alt me-1"></i> 脱退
        </button>
        {% endif %}
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{# --- 1. ヒーロー統計エリア --- #}
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card hero-stat-card shadow-sm h-100">
            <div class="card-body d-flex align-items-center p-3">
                <div class="hero-stat-icon bg-light text-primary me-3"><i class="fas fa-users"></i></div>
                <div>
                    <h6 class="text-uppercase text-muted fw-bold mb-0" style="font-size: 0.7rem;">Members</h6>
                    <h3 class="mb-0 fw-bold">{{ team_stats.member_count }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card hero-stat-card shadow-sm h-100">
            <div class="card-body d-flex align-items-center p-3">
                <div class="hero-stat-icon bg-light text-success me-3"><i class="fas fa-calendar-alt"></i></div>
                <div>
                    <h6 class="text-uppercase text-muted fw-bold mb-0" style="font-size: 0.7rem;">Upcoming Events</h6>
                    <h3 class="mb-0 fw-bold">{{ team_stats.event_count }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card hero-stat-card shadow-sm h-100">
            <div class="card-body d-flex align-items-center p-3">
                <div class="hero-stat-icon bg-light text-info me-3"><i class="fas fa-running"></i></div>
                <div>
                    <h6 class="text-uppercase text-muted fw-bold mb-0" style="font-size: 0.7rem;">Total Logs</h6>
                    <h3 class="mb-0 fw-bold">{{ team_stats.total_logs }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    {# --- 左カラム: イベント & タイムライン --- #}
    <div class="col-lg-8">
        
        {# イベントセクション #}
        <div class="card section-card shadow-sm mb-4">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-calendar-day me-2 text-primary"></i>Events</h5>
                <a href="{{ url_for('event.add_event', team_id=team.id) }}" class="btn btn-sm btn-primary rounded-pill px-3">
                    <i class="fas fa-plus me-1"></i> 作成
                </a>
            </div>
            <div class="card-body p-0">
                {% if upcoming_events %}
                    <div class="list-group list-group-flush">
                        {% for event in upcoming_events %}
                        <div class="list-group-item border-0 border-bottom p-3 hover-lift">
                            <div class="d-flex align-items-start">
                                {# 日付バッジ #}
                                <div class="event-date-badge me-3 flex-shrink-0">
                                    <div class="event-date-month">{{ event.start_datetime.strftime('%b') }}</div>
                                    <div class="event-date-day">{{ event.start_datetime.strftime('%d') }}</div>
                                </div>
                                
                                <div class="flex-grow-1 min-width-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="mb-1 fw-bold text-truncate">
                                            <a href="{{ url_for('event.event_detail', event_id=event.id) }}" class="text-dark text-decoration-none stretched-link">
                                                {{ event.title }}
                                            </a>
                                        </h5>
                                        
                                        {# 参加状況バッジ (PC表示用) #}
                                        <div class="d-none d-md-block text-end">
                                            {% set attending = event.participants.filter_by(status='attending').count() %}
                                            <span class="badge bg-light text-dark border">
                                                <i class="fas fa-user-check me-1"></i> {{ attending }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <p class="mb-1 text-muted small text-truncate">
                                        <i class="far fa-clock me-1"></i> {{ event.start_datetime.strftime('%H:%M') }}
                                        {% if event.location %}
                                            <span class="mx-2">|</span> <i class="fas fa-map-marker-alt me-1"></i> {{ event.location }}
                                        {% endif %}
                                    </p>
                                    
                                    <div class="d-flex align-items-center mt-2">
                                        <img src="{{ event.owner.avatar_url or url_for('static', filename='images/blobcat_8bit.webp') }}" class="rounded-circle me-2" width="20" height="20">
                                        <span class="small text-muted me-3">{{ event.owner.display_name or event.owner.misskey_username }}</span>
                                        
                                        {# モバイル用参加バッジ #}
                                        <div class="d-md-none">
                                            {% set attending = event.participants.filter_by(status='attending').count() %}
                                            <span class="badge bg-light text-dark border">
                                                <i class="fas fa-user-check me-1"></i> {{ attending }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3 text-muted opacity-50"><i class="far fa-calendar-times fa-3x"></i></div>
                        <p class="text-muted">予定されているイベントはありません</p>
                    </div>
                {% endif %}
            </div>
        </div>

        {# 活動ログ（タイムライン）セクション #}
        <div class="card section-card shadow-sm">
            <div class="section-header">
                <h5 class="mb-0 fw-bold"><i class="fas fa-stream me-2 text-info"></i>Recent Activity</h5>
            </div>
            <div class="card-body p-0">
                {% if recent_activities %}
                    <div class="list-group list-group-flush">
                        {% for activity in recent_activities %}
                        <a href="{{ url_for('activity.detail_activity', activity_id=activity.id) }}" class="list-group-item list-group-item-action border-0 border-bottom p-3 hover-lift">
                            <div class="d-flex">
                                <img src="{{ activity.user.avatar_url or url_for('static', filename='images/blobcat_8bit.webp') }}" class="rounded-circle me-3 flex-shrink-0" width="48" height="48">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1 fw-bold text-primary">{{ activity.activity_title }}</h6>
                                        <small class="text-muted">{{ activity.activity_date.strftime('%m/%d') }}</small>
                                    </div>
                                    <p class="mb-1 small text-dark">
                                        {{ activity.user.display_name or activity.user.misskey_username }} 
                                        <span class="text-muted">@ {{ activity.location_name_display }}</span>
                                    </p>
                                    <div class="d-flex align-items-center small text-muted">
                                        <i class="fas fa-motorcycle me-1"></i> {{ activity.motorcycle.name }}
                                        {% if activity.notes %}
                                            <span class="mx-2">|</span> <span class="text-truncate" style="max-width: 200px;">{{ activity.notes }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted">まだ活動ログがありません</p>
                    </div>
                {% endif %}
            </div>
        </div>

    </div>

    {# --- 右カラム: ランキング & メンバー --- #}
    <div class="col-lg-4">
        
        {# サーキットランキング #}
        <div class="card section-card shadow-sm mb-4">
            <div class="section-header bg-white">
                <h5 class="mb-0 fw-bold"><i class="fas fa-trophy me-2 text-warning"></i>Top Times</h5>
            </div>
            <div class="card-body p-0">
                {% if circuit_data %}
                    <div class="accordion accordion-flush" id="circuitRankingsAccordion">
                        {% for circuit_name, rankings in circuit_data.items()|sort %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-{{ loop.index }}">
                                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false">
                                    <div class="d-flex flex-column align-items-start w-100">
                                        <div class="fw-bold text-dark mb-1">{{ circuit_name }}</div>
                                        <div class="small text-muted">
                                            <i class="fas fa-crown text-warning me-1"></i> {{ format_seconds_to_time(rankings[0].best_lap) }}
                                            <span class="ms-1">({{ rankings[0].user.display_name or rankings[0].user.misskey_username }})</span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#circuitRankingsAccordion">
                                <div class="accordion-body p-0">
                                    <ul class="list-group list-group-flush">
                                        {% for rank_item in rankings %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                            <div class="d-flex align-items-center text-truncate">
                                                <span class="medal-icon">
                                                    {% if loop.index == 1 %}<i class="fas fa-medal medal-gold"></i>
                                                    {% elif loop.index == 2 %}<i class="fas fa-medal medal-silver"></i>
                                                    {% elif loop.index == 3 %}<i class="fas fa-medal medal-bronze"></i>
                                                    {% else %}<span class="small text-muted fw-bold">{{ loop.index }}</span>{% endif %}
                                                </span>
                                                <img src="{{ rank_item.user.avatar_url or url_for('static', filename='images/blobcat_8bit.webp') }}" class="rounded-circle me-2" width="24" height="24">
                                                <span class="small text-truncate" style="max-width: 100px;">{{ rank_item.user.display_name or rank_item.user.misskey_username }}</span>
                                            </div>
                                            <span class="small fw-bold font-monospace">{{ format_seconds_to_time(rank_item.best_lap) }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="p-4 text-center text-muted small">
                        走行データがありません
                    </div>
                {% endif %}
            </div>
        </div>

        {# メンバーリスト #}
        <div class="card section-card shadow-sm">
            <div class="section-header">
                <h5 class="mb-0 fw-bold"><i class="fas fa-users me-2 text-secondary"></i>Members</h5>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for member in members %}
                    <li class="list-group-item d-flex align-items-center py-2 border-0">
                        <img src="{{ member.avatar_url or url_for('static', filename='images/blobcat_8bit.webp') }}" class="rounded-circle me-3" width="32" height="32">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small fw-bold">{{ member.display_name or member.misskey_username }}</span>
                                {% if member.id == team.owner_id %}
                                    <span class="badge bg-light text-dark border" style="font-size: 0.6rem;">OWNER</span>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>
</div>

{# チーム脱退モーダル #}
{% if team.owner_id != current_user.id %}
<div class="modal fade" id="leaveTeamModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">チームからの脱退</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">本当にチーム「<strong>{{ team.name }}</strong>」から脱退しますか？</p>
        <p class="text-danger small mb-0"><i class="fas fa-exclamation-triangle me-1"></i> この操作は取り消せません。再参加には招待が必要です。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <form method="POST" action="{{ url_for('team.leave_team', team_id=team.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-danger">脱退する</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}