{# motopuppu/templates/fuel_log.html #}
{% extends "base.html" %}

{% block title %}給油記録 - motopuppu{% endblock %}

{% block content %}
<h2>給油記録</h2>
<p>過去の給油記録一覧です。</p>

{# --- フラッシュメッセージ表示 --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="mb-3">
    <a href="{{ url_for('fuel.add_fuel') }}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i> 給油記録を追加
    </a>
    {# フィルター機能などを後で追加 #}
</div>

{% if fuel_entries %}
<div class="table-responsive">
    <table class="table table-striped table-hover table-sm"> {# table-sm で少しコンパクトに #}
        <thead>
            <tr>
                <th>給油日</th>
                <th>車両</th>
                <th>ODO(km)</th>
                <th>総走行距離(km)</th>
                <th>給油量(L)</th>
                <th>単価(円/L)</th>
                <th>合計(円)</th>
                <th>燃費(km/L)</th>
                <th>スタンド</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in fuel_entries %}
            <tr>
                <td>{{ entry.entry_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ entry.motorcycle.name }}</td>
                <td class="text-end">{{ "{:,}".format(entry.odometer_reading) }}</td> {# 桁区切り #}
                <td class="text-end">{{ "{:,}".format(entry.total_distance) }}</td> {# 桁区切り #}
                <td class="text-end">{{ "%.2f"|format(entry.fuel_volume) }}</td> {# 小数点以下2桁 #}
                <td class="text-end">
                    {% if entry.price_per_liter %}{{ "%.1f"|format(entry.price_per_liter) }}{% else %}-{% endif %}
                </td>
                 <td class="text-end">
                    {% if entry.total_cost %}{{ "{:,.0f}".format(entry.total_cost) }}{% else %}-{% endif %} {# 整数表示 #}
                </td>
                <td class="text-end fw-bold"> {# 燃費を太字に #}
                    {% set kml = entry.km_per_liter %} {# プロパティを呼び出し #}
                    {% if kml %}{{ "%.2f"|format(kml) }}{% else %}-{% endif %}
                </td>
                <td>{{ entry.station_name if entry.station_name else '-' }}</td>
                <td>
                    {# 編集ボタン #}
                    <a href="{{ url_for('fuel.edit_fuel', entry_id=entry.id) }}" class="btn btn-sm btn-outline-secondary me-1">
                        <i class="fas fa-edit"></i>
                    </a>
                    {# 削除ボタン #}
                    <form action="{{ url_for('fuel.delete_fuel', entry_id=entry.id) }}" method="POST" class="d-inline" onsubmit="return confirm('この給油記録を削除してもよろしいですか？');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# --- ページネーション --- #}
{% if pagination %}
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {# 前へ #}
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('fuel.fuel_log', page=pagination.prev_num) if pagination.has_prev else '#' }}" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {# ページ番号 #}
    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
      {% if page_num %}
        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('fuel.fuel_log', page=page_num) }}">{{ page_num }}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
    {% endfor %}
    {# 次へ #}
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('fuel.fuel_log', page=pagination.next_num) if pagination.has_next else '#' }}" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>
{% endif %}
{# --- ページネーション ここまで --- #}

{% else %}
<div class="alert alert-info" role="alert">
  給油記録はまだありません。「給油記録を追加」ボタンから最初の記録を追加しましょう。
</div>
{% endif %}

{% endblock %}
