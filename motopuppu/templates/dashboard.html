{# motopuppu/templates/dashboard.html #}
{% extends "base.html" %}

{% block title %}ダッシュボード - もとぷっぷー{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* タイムラインのスタイル */
    .dashboard-timeline {
        list-style: none;
        padding: 0;
        position: relative;
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding-left: 50px;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 18px;
        top: 20px;
        bottom: -1.5rem;
        width: 4px;
        background-color: #e9ecef;
        z-index: 1;
    }
    .timeline-item:last-child::before {
        display: none;
    }
    .timeline-item-marker {
        position: absolute;
        top: 0;
        left: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #fff;
        border: 4px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        z-index: 10;
    }
    .timeline-item-marker.type-fuel {
        color: #198754;
        border-color: #198754;
    }
    .timeline-item-marker.type-maintenance {
        color: #ffc107;
        border-color: #ffc107;
    }
    .timeline-item-content {
        position: relative;
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        border: 1px solid #e9ecef;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }
    .timeline-item-content:hover {
        background-color: #f1f3f5;
        border-color: #dee2e6;
    }
    .timeline-item-date {
        font-weight: 600;
        font-size: 0.9rem;
        color: #6c757d;
    }
    .timeline-item-title {
        font-weight: 600;
        margin-bottom: 0.1rem;
        color: #212529;
    }
    .timeline-item-description {
        font-size: 0.9rem;
        color: #495057;
    }
    .timeline-item-cost {
        font-size: 0.85rem;
        color: #6c757d;
    }
    #timelineDetailModal .modal-header .icon-fuel { color: #198754; }
    #timelineDetailModal .modal-header .icon-maintenance { color: #ffc107; }

    /* ポップオーバーの最大幅など */
    .motopuppu-popover {
        max-width: 350px;
    }
    /* 日付セルの高さを少し確保（イベントが多いときに見やすく） */
    .fc-daygrid-day-frame {
        min-height: 100px;
    }
    /* 祝日の背景色など */
    .fc .fc-daygrid-day.fc-day-holiday {
        background-color: rgba(255, 0, 0, 0.05);
    }
    /* 土日の日付番号の色 */
    .fc .fc-daygrid-day-number.is-sat {
        color: #0d6efd;
    }
    .fc .fc-daygrid-day-number.is-sun, .fc .fc-daygrid-day-number.is-holiday {
        color: #dc3545;
    }
    /* 祝日名 */
    .fc-holiday-name {
        display: block;
        font-size: 0.7em;
        text-align: center;
        color: #dc3545;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        padding: 0 2px;
        margin-top: -2px;
    }
    /* TODOリストのスタイル調整 */
    .motopuppu-popover .list-unstyled li {
        margin-bottom: 0.2rem;
    }
    .motopuppu-popover .list-unstyled label {
        vertical-align: middle;
        word-break: break-word;
    }
    .motopuppu-popover .form-check-input {
        margin-top: 0.1em;
        cursor: default;
    }
    /* 並び替えモード用のスタイル */
    .widget-grab-handle {
        cursor: grab;
        display: none; /* 通常時は非表示 */
    }
    .sortable-ghost {
        opacity: 0.4;
        background: #c8ebfb;
    }
    #dashboard-widgets-container.is-sorting .widget-grab-handle {
        display: inline-block;
    }
    #dashboard-widgets-container.is-sorting .card-header {
        background-color: #f0f8ff; /* 並び替え中はヘッダー色を少し変える */
    }
</style>
{% endblock %}

{% block content %}
{# --- ヘッダー --- #}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{% if current_user.is_authenticated %}ようこそ、{{ current_user.display_name or current_user.misskey_username }}さん{% else %}ダッシュボード{% endif %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div id="layout-buttons-default" class="me-2">
            {# ▼▼▼ 変更箇所 ▼▼▼ #}
            <button id="edit-layout-btn" type="button" class="btn btn-sm btn-outline-secondary" title="レイアウトを編集" aria-label="レイアウトを編集">
                <i class="bi bi-gear-fill"></i>
            </button>
            {# ▲▲▲ 変更ここまで ▲▲▲ #}
        </div>
        <div id="layout-buttons-editing" class="btn-group me-2" style="display: none;">
            <button id="save-layout-btn" type="button" class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i> 保存</button>
            <button id="reset-layout-btn" type="button" class="btn btn-sm btn-info text-white"><i class="fas fa-undo me-1"></i> デフォルトに戻す</button>
            <button id="cancel-layout-btn" type="button" class="btn btn-sm btn-secondary"><i class="fas fa-times me-1"></i> キャンセル</button>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('fuel.add_fuel') }}" class="btn btn-sm btn-success"><i class="fas fa-gas-pump me-1"></i> 給油記録を追加</a>
            <a href="{{ url_for('maintenance.add_maintenance') }}" class="btn btn-sm btn-warning text-white"><i class="fas fa-tools me-1"></i> 整備記録を追加</a>
            <a href="{{ url_for('notes.add_note') }}" class="btn btn-sm btn-primary"><i class="fas fa-sticky-note me-1"></i> ノートを追加</a>
        </div>
    </div>
</div>

{# --- フラッシュメッセージ --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message | safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{# ▼▼▼ accordionクラスを追加 ▼▼▼ #}
<div id="dashboard-widgets-container" class="accordion dashboard-widgets">
    {% for widget_name in dashboard_layout %}
        {% if widget_name == 'reminders' %}
            {% include 'dashboard/_reminders_widget.html' %}
        {% elif widget_name == 'stats' %}
            {% include 'dashboard/_stats_widget.html' %}
        {% elif widget_name == 'vehicles' %}
            {% include 'dashboard/_vehicles_widget.html' %}
        {% elif widget_name == 'timeline' %}
            {% include 'dashboard/_timeline_widget.html' %}
        {# ▼▼▼【ここから追記】▼▼▼ #}
        {% elif widget_name == 'circuit' %}
            {% include 'dashboard/_circuit_widget.html' %}
        {# ▲▲▲【追記はここまで】▲▲▲ #}
        {% elif widget_name == 'calendar' %}
            {% include 'dashboard/_calendar_widget.html' %}
        {% endif %}
    {% endfor %}
</div>

<div class="modal fade" id="timelineDetailModal" tabindex="-1" aria-labelledby="timelineDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="timelineDetailModalLabel">
            <span id="modal-icon-placeholder"></span>
            <span id="modal-title-placeholder"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
            <dt class="col-sm-4">日付</dt>
            <dd class="col-sm-8" id="modal-date"></dd>

            <dt class="col-sm-4">ODOメーター</dt>
            <dd class="col-sm-8" id="modal-odo"></dd>
        </dl>
        <hr>
        <dl class="row" id="modal-details-container"></dl>
      </div>
      <div class="modal-footer">
        <a href="#" id="modal-edit-button" class="btn btn-primary">編集する</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# ▼▼▼【重要】この行を追加して、FullCalendarライブラリを読み込みます ▼▼▼ #}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
{# ▲▲▲ 追加はここまで ▲▲▲ #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- レイアウト並び替え機能 ---
    const widgetsContainer = document.getElementById('dashboard-widgets-container');
    const editBtn = document.getElementById('edit-layout-btn');
    const saveBtn = document.getElementById('save-layout-btn');
    const cancelBtn = document.getElementById('cancel-layout-btn');
    const resetBtn = document.getElementById('reset-layout-btn');
    const defaultButtons = document.getElementById('layout-buttons-default');
    const editingButtons = document.getElementById('layout-buttons-editing');
    
    let sortable = null;
    let originalOrder = [];
    const defaultOrder = ['reminders', 'stats', 'vehicles', 'timeline', 'circuit', 'calendar'];

    const reorderWidgets = (order) => {
        const fragment = document.createDocumentFragment();
        order.forEach(widgetName => {
            const widgetEl = widgetsContainer.querySelector(`[data-widget-name="${widgetName}"]`);
            if (widgetEl) {
                fragment.appendChild(widgetEl);
            }
        });
        widgetsContainer.innerHTML = '';
        widgetsContainer.appendChild(fragment);
    };

    // 並び替えモードを開始
    editBtn.addEventListener('click', function() {
        originalOrder = Array.from(widgetsContainer.children).map(el => el.dataset.widgetName);

        widgetsContainer.classList.add('is-sorting');
        defaultButtons.style.display = 'none';
        editingButtons.style.display = 'inline-flex';

        sortable = new Sortable(widgetsContainer, {
            animation: 150,
            handle: '.widget-grab-handle',
            ghostClass: 'sortable-ghost',
        });
    });

    const endEditingMode = () => {
        if (sortable) {
            sortable.destroy();
            sortable = null;
        }
        widgetsContainer.classList.remove('is-sorting');
        defaultButtons.style.display = 'block';
        editingButtons.style.display = 'none';
    };

    // 変更を保存
    saveBtn.addEventListener('click', function() {
        // ▼▼▼ 変更・追記 ▼▼▼
        // sortable.toArray() の代わりに、DOMから直接data-widget-name属性を読み取る
        const newOrder = Array.from(widgetsContainer.children).map(el => el.dataset.widgetName);
        // ▲▲▲ 変更・追記 ここまで ▲▲▲

        const csrfTokenEl = document.querySelector('meta[name="csrf-token"]');
        if (!csrfTokenEl) {
            alert('エラー: CSRFトークンが見つかりません。base.htmlを確認してください。');
            return;
        }
        const csrfToken = csrfTokenEl.getAttribute('content');

        fetch("{{ url_for('main.save_dashboard_layout') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ layout: newOrder })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('Failed to save layout:', data.message);
                alert('レイアウトの保存に失敗しました。');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('通信エラーが発生しました。');
        })
        .finally(() => {
            endEditingMode();
        });
    });
    
    // デフォルトに戻す
    resetBtn.addEventListener('click', function() {
        reorderWidgets(defaultOrder);
    });

    // 変更をキャンセル
    cancelBtn.addEventListener('click', function() {
        reorderWidgets(originalOrder);
        endEditingMode();
    });

    // --- タイムライン機能 ---
    const filterButtons = document.getElementById('timeline-filter-buttons');
    if (filterButtons) {
        filterButtons.addEventListener('click', function(e) {
            const button = e.target.closest('button');
            if (button) {
                const filter = button.dataset.filter;
                
                filterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.querySelectorAll('.timeline-item').forEach(item => {
                    if (filter === 'all' || item.dataset.eventType === filter) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        });
    }

    const timelineDetailModal = document.getElementById('timelineDetailModal');
    if (timelineDetailModal) {
        timelineDetailModal.addEventListener('show.bs.modal', function (event) {
            const item = event.relatedTarget;
            const eventType = item.dataset.eventType;
            const details = JSON.parse(item.dataset.eventDetails);
            const editUrl = item.dataset.eventEditUrl;
            
            const modalTitle = timelineDetailModal.querySelector('#modal-title-placeholder');
            const modalIcon = timelineDetailModal.querySelector('#modal-icon-placeholder');
            const modalDate = timelineDetailModal.querySelector('#modal-date');
            const modalOdo = timelineDetailModal.querySelector('#modal-odo');
            const modalDetailsContainer = timelineDetailModal.querySelector('#modal-details-container');
            const modalEditButton = timelineDetailModal.querySelector('#modal-edit-button');

            if (eventType === 'fuel') {
                modalIcon.innerHTML = '<i class="fas fa-gas-pump icon-fuel"></i>';
                modalTitle.textContent = '給油記録詳細';
            } else if (eventType === 'maintenance') {
                modalIcon.innerHTML = '<i class="fas fa-tools icon-maintenance"></i>';
                modalTitle.textContent = '整備記録詳細';
            }

            modalDate.textContent = item.dataset.eventDate;
            modalOdo.textContent = `${parseInt(item.dataset.eventOdo).toLocaleString()} km`;

            modalDetailsContainer.innerHTML = '';
            for (const [key, value] of Object.entries(details)) {
                if (key === '車両名') {
                   const selectedVehicle = document.querySelector('select[name="timeline_vehicle_id"]');
                   if (selectedVehicle && selectedVehicle.value !== 'all') continue;
                }

                const dt = document.createElement('dt');
                dt.className = 'col-sm-4';
                dt.textContent = key;
                const dd = document.createElement('dd');
                dd.className = 'col-sm-8';
                dd.textContent = value;
                modalDetailsContainer.appendChild(dt);
                modalDetailsContainer.appendChild(dd);
            }
            
            modalEditButton.href = editUrl;
        });
    }
    
    // --- カレンダー機能 ---
    var calendarEl = document.getElementById('calendar');
    // (カレンダーのJSは長いため、変更がないのでここでは省略します)
    // ... 既存のカレンダーJSコード ...
    let holidaysMap = {};
    try {
        const holidaysData = JSON.parse('{{ holidays_json | safe }}');
        if (typeof holidaysData === 'object' && holidaysData !== null) {
            holidaysMap = holidaysData;
        } else {
            console.error("Invalid holidays data format:", holidaysData);
        }
    } catch (e) {
        console.error("Error parsing holidays JSON:", e);
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    if (calendarEl) {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek,listMonth'
            },
            buttonText: {
                today: '今日',
                month: '月',
                week: '週',
                list: 'リスト(月)'
            },
            contentHeight: 'auto',
            dayCellContent: function(arg) {
                return { html: `<span class="fc-daygrid-day-number">${arg.date.getDate()}</span>` };
            },
            dayCellDidMount: function(arg) {
                const year = arg.date.getFullYear();
                const month = (arg.date.getMonth() + 1).toString().padStart(2, '0');
                const day = arg.date.getDate().toString().padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                const dayNumberEl = arg.el.querySelector('.fc-daygrid-day-number');
                const dayTopEl = arg.el.querySelector('.fc-daygrid-day-top');
                const dayOfWeek = arg.date.getDay();

                if (!dayNumberEl || !dayTopEl) return;
                
                arg.el.classList.remove('fc-day-holiday', 'fc-day-sun', 'fc-day-sat');
                dayNumberEl.classList.remove('is-holiday', 'is-sun', 'is-sat');
                
                const existingHolidayName = dayTopEl.querySelector('.fc-holiday-name');
                if (existingHolidayName) {
                    dayTopEl.removeChild(existingHolidayName);
                }
                
                if (holidaysMap.hasOwnProperty(dateStr)) {
                    const holidayName = holidaysMap[dateStr];
                    const holidayNameEl = document.createElement('span');
                    holidayNameEl.classList.add('fc-holiday-name');
                    holidayNameEl.textContent = holidayName;
                    dayTopEl.appendChild(holidayNameEl);
                    arg.el.classList.add('fc-day-holiday');
                    dayNumberEl.classList.add('is-holiday');
                } else if (dayOfWeek === 0) { // Sunday
                    arg.el.classList.add('fc-day-sun');
                    dayNumberEl.classList.add('is-sun');
                } else if (dayOfWeek === 6) { // Saturday
                    arg.el.classList.add('fc-day-sat');
                    dayNumberEl.classList.add('is-sat');
                }
            },
            events: '/api/dashboard/events',
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                const editUrl = info.event.extendedProps?.editUrl || info.event.url;
                if (editUrl) {
                    window.location.href = editUrl;
                }
            },
            eventDidMount: function(info) {
                if (info.event.extendedProps) {
                    var props = info.event.extendedProps;
                    var popoverTitle = '';
                    var popoverContent = '';

                    var eventDateStr = '日付不明';
                    if (info.event.start) {
                        try {
                            eventDateStr = info.event.start.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
                        } catch (e) {
                            eventDateStr = info.event.start.toISOString().split('T')[0];
                            console.warn("toLocaleDateString failed, using fallback date format:", eventDateStr, e);
                        }
                    }

                    var editUrl = props.editUrl;

                    if (props.type === 'fuel') {
                        popoverTitle = `⛽ 給油 (${escapeHtml(props.motorcycleName || '車両不明')})`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>日付:</dt><dd>${escapeHtml(eventDateStr)}</dd>` +
                            `<dt>ODO:</dt><dd>${props.odometer ? escapeHtml(props.odometer.toLocaleString()) + ' km' : '-'}</dd>` +
                            `<dt>給油量:</dt><dd>${props.fuelVolume ? escapeHtml(props.fuelVolume.toFixed(2)) + ' L' : '-'}</dd>` +
                            `<dt>燃費:</dt><dd>${props.kmPerLiter || '-'}</dd>` +
                            `<dt>金額:</dt><dd>${props.totalCost ? escapeHtml(props.totalCost.toLocaleString()) + ' 円' : '-'}</dd>` +
                            (props.stationName ? `<dt>スタンド:</dt><dd>${escapeHtml(props.stationName)}</dd>` : '') +
                            (props.notes ? `<dt>メモ:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.notes)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'maintenance') {
                        popoverTitle = `🔧 ${escapeHtml(props.category || '整備')} (${escapeHtml(props.motorcycleName || '車両不明')})`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>日付:</dt><dd>${escapeHtml(eventDateStr)}</dd>` +
                            `<dt>ODO:</dt><dd>${props.odometer ? escapeHtml(props.odometer.toLocaleString()) + ' km' : '-'}</dd>` +
                            `<dt>内容:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.description || '記載なし')}</dd>` +
                            (props.category ? `<dt>カテゴリ:</dt><dd>${escapeHtml(props.category)}</dd>` : '') +
                            `<dt>費用:</dt><dd>${props.totalCost ? escapeHtml(props.totalCost.toLocaleString()) + ' 円' : '-'}</dd>` +
                            (props.location ? `<dt>場所:</dt><dd>${escapeHtml(props.location)}</dd>` : '') +
                            (props.notes ? `<dt>メモ:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.notes)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'activity') {
                        let racerBadge = props.isRacer ? ' <span class="badge bg-info text-dark small">レーサー</span>' : '';
                        popoverTitle = `🏁 ${escapeHtml(props.activityTitle)} (${escapeHtml(props.motorcycleName || '車両不明')}${racerBadge})`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>日付:</dt><dd>${escapeHtml(eventDateStr)}</dd>` +
                            `<dt>場所:</dt><dd>${escapeHtml(props.location || '未設定')}</dd>` +
                            (props.weather ? `<dt>天候:</dt><dd>${escapeHtml(props.weather)}</dd>` : '') +
                            (props.temperature ? `<dt>気温:</dt><dd>${escapeHtml(props.temperature)}</dd>` : '') +
                            (props.notes ? `<dt>メモ:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.notes)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'note') {
                        let noteTitle = props.title || '(無題のノート)';
                        let racerBadge = props.isRacer ? ' <span class="badge bg-info text-dark small">レーサー</span>' : '';
                        popoverTitle = `📝 ノート ${props.motorcycleName ? '(' + escapeHtml(props.motorcycleName) + racerBadge + ')' : ''}`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>日付:</dt><dd>${escapeHtml(props.noteDate || eventDateStr)}</dd>` +
                            `<dt>タイトル:</dt><dd>${escapeHtml(noteTitle)}</dd>` +
                            `<dt>内容:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.content || '記載なし')}</dd>` +
                            (props.motorcycleName ? `<dt>関連車両:</dt><dd>${escapeHtml(props.motorcycleName)}</dd>` : '') +
                            (props.createdAt ? `<dt>作成:</dt><dd>${escapeHtml(props.createdAt)}</dd>` : '') +
                            (props.updatedAt ? `<dt>更新:</dt><dd>${escapeHtml(props.updatedAt)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'task') {
                        let taskTitle = props.title || '(無題のタスク)';
                        let racerBadge = props.isRacer ? ' <span class="badge bg-info text-dark small">レーサー</span>' : '';
                        popoverTitle = `✅ タスク ${props.motorcycleName ? '(' + escapeHtml(props.motorcycleName) + racerBadge + ')' : ''}`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>日付:</dt><dd>${escapeHtml(props.noteDate || eventDateStr)}</dd>` +
                            `<dt>タイトル:</dt><dd>${escapeHtml(taskTitle)}</dd>` +
                            (props.motorcycleName ? `<dt>関連車両:</dt><dd>${escapeHtml(props.motorcycleName)}</dd>` : '') +
                            '<dt>TODO:</dt><dd>';
                        if (props.todos && Array.isArray(props.todos) && props.todos.length > 0) {
                            popoverContent += '<ul class="list-unstyled mb-0 small ps-1">';
                            props.todos.forEach(function(todo, index) {
                                const isChecked = todo && todo.checked;
                                const text = todo && todo.text ? escapeHtml(todo.text) : '(空)';
                                const checkboxId = `todo-${info.event.id}-${index}`;
                                popoverContent += `<li class="d-flex align-items-center">` +
                                    `<input type="checkbox" id="${checkboxId}" disabled ${isChecked ? 'checked' : ''} class="form-check-input me-1">` +
                                    `<label for="${checkboxId}" class="${isChecked ? 'text-decoration-line-through text-muted' : ''}">${text}</label>` +
                                    `</li>`;
                            });
                            popoverContent += '</ul>';
                        } else {
                            popoverContent += '<span class="text-muted">TODOはありません</span>';
                        }
                        popoverContent += '</dd>';
                        popoverContent += (props.createdAt ? `<dt>作成:</dt><dd>${escapeHtml(props.createdAt)}</dd>` : '') +
                                        (props.updatedAt ? `<dt>更新:</dt><dd>${escapeHtml(props.updatedAt)}</dd>` : '');
                        popoverContent += `</dl>`;
                    }

                    if (editUrl) {
                        popoverContent += `<a href="${escapeHtml(editUrl)}" class="btn btn-sm btn-outline-primary mt-2 py-0 px-1" title="編集"><i class="fas fa-edit fa-xs me-1"></i>編集</a>`;
                    }
                    
                    if (popoverTitle && popoverContent) {
                        var popover = new bootstrap.Popover(info.el, {
                            title: popoverTitle,
                            content: popoverContent,
                            trigger: 'hover focus',
                            placement: 'auto',
                            boundary: 'viewport',
                            html: true,
                            sanitize: false,
                            container: 'body',
                            customClass: 'motopuppu-popover'
                        });
                        info.el.addEventListener('remove', () => {
                            if(popover) {
                                popover.dispose();
                            }
                        });
                    }
                }
            }
        });
        calendar.render();
    } else {
        console.error("Calendar element (#calendar) not found");
    }

// ▼▼▼【ここから追記】ウィジェット開閉状態の保存・復元機能 ▼▼▼
    const WIDGET_STATE_KEY = 'dashboardWidgetStates';

    // localStorageから状態を読み込み、ウィジェットに適用する関数
    const applyWidgetStates = () => {
        const savedStatesJSON = localStorage.getItem(WIDGET_STATE_KEY);
        if (!savedStatesJSON) {
            return; // 保存されたデータがなければ何もしない
        }
        
        try {
            const savedStates = JSON.parse(savedStatesJSON);
            const widgets = widgetsContainer.querySelectorAll('.accordion-item');

            widgets.forEach(widget => {
                const widgetName = widget.dataset.widgetName;
                if (widgetName in savedStates) {
                    const shouldBeOpen = savedStates[widgetName];
                    const collapseElement = widget.querySelector('.accordion-collapse');
                    const button = widget.querySelector('.accordion-button');

                    if (shouldBeOpen) {
                        collapseElement.classList.add('show');
                        button.classList.remove('collapsed');
                        button.setAttribute('aria-expanded', 'true');
                    } else {
                        collapseElement.classList.remove('show');
                        button.classList.add('collapsed');
                        button.setAttribute('aria-expanded', 'false');
                    }
                }
            });
        } catch (e) {
            console.error('Failed to parse widget states from localStorage', e);
            localStorage.removeItem(WIDGET_STATE_KEY); // 不正なデータを削除
        }
    };

    // 現在のウィジェットの状態をlocalStorageに保存する関数
    const saveWidgetStates = () => {
        const states = {};
        const widgets = widgetsContainer.querySelectorAll('.accordion-item');
        widgets.forEach(widget => {
            const widgetName = widget.dataset.widgetName;
            const collapseElement = widget.querySelector('.accordion-collapse');
            states[widgetName] = collapseElement.classList.contains('show');
        });
        localStorage.setItem(WIDGET_STATE_KEY, JSON.stringify(states));
    };

    // ページ読み込み時に状態を復元
    applyWidgetStates();

    // ウィジェットが開かれたり閉じられたりした後に、状態を保存
    widgetsContainer.addEventListener('shown.bs.collapse', saveWidgetStates);
    widgetsContainer.addEventListener('hidden.bs.collapse', saveWidgetStates);
    // ▲▲▲【追記はここまで】▲▲▲

    // ▼▼▼【ここから追記】コスト表示トグル機能 ▼▼▼
    const costToggle = document.getElementById('cost-display-toggle');
    if (costToggle) {
        costToggle.addEventListener('change', function() {
            const csrfTokenEl = document.querySelector('meta[name="csrf-token"]');
            if (!csrfTokenEl) {
                alert('エラー: CSRFトークンが見つかりません。');
                return;
            }
            const csrfToken = csrfTokenEl.getAttribute('content');

            // トグル操作中は操作不可にする
            this.disabled = true;

            fetch("{{ url_for('main.toggle_dashboard_cost_display') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (response.ok) {
                    // 成功したらページをリロードして表示を更新
                    window.location.reload();
                } else {
                    // 失敗した場合、トグルを元の状態に戻してアラートを表示
                    this.checked = !this.checked;
                    this.disabled = false;
                    alert('設定の変更に失敗しました。ページを再読み込みしてください。');
                }
            })
            .catch(error => {
                console.error('Error toggling cost display:', error);
                this.checked = !this.checked;
                this.disabled = false;
                alert('通信エラーが発生しました。');
            });
        });
    }
    // ▲▲▲【追記はここまで】▲▲▲
});
</script>
{% endblock %}