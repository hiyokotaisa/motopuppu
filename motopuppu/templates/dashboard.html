{# motopuppu/templates/dashboard.html #}
{% extends "base.html" %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - motopuppu{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    {# g.user ãŒå­˜åœ¨ã™ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º #}
    <h1 class="h2">{% if g.user %}ã‚ˆã†ã“ãã€{{ g.user.misskey_username }}ã•ã‚“{% else %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endif %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
         {# æ©Ÿèƒ½ã¸ã®ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ #}
         <div class="btn-group me-2">
             {# çµ¦æ²¹è¨˜éŒ²ã‚’è¿½åŠ : èƒŒæ™¯=ç·‘ã€æ–‡å­—=ç™½ (btn-success) #}
            <a href="{{ url_for('fuel.add_fuel') }}" class="btn btn-sm btn-success">
                <i class="fas fa-gas-pump me-1"></i> çµ¦æ²¹è¨˜éŒ²ã‚’è¿½åŠ 
            </a>
             {# æ•´å‚™è¨˜éŒ²ã‚’è¿½åŠ : èƒŒæ™¯=é»„ã€æ–‡å­—=ç™½ (btn-warning text-white) #}
            <a href="{{ url_for('maintenance.add_maintenance') }}" class="btn btn-sm btn-warning text-white"> {# å…ƒã®ã‚¯ãƒ©ã‚¹ 'btn-success' ã‹ã‚‰å¤‰æ›´ #}
                <i class="fas fa-tools me-1"></i> æ•´å‚™è¨˜éŒ²ã‚’è¿½åŠ 
            </a>
             {# è»Šä¸¡ç®¡ç†: èƒŒæ™¯=æ°´è‰²ã€æ–‡å­—=ç™½ (btn-info) #}
             <a href="{{ url_for('vehicle.vehicle_list') }}" class="btn btn-sm btn-info"> {# å…ƒã®ã‚¯ãƒ©ã‚¹ 'btn-outline-info' ã‹ã‚‰å¤‰æ›´ #}
                <i class="fas fa-motorcycle me-1"></i> è»Šä¸¡ç®¡ç†
            </a>
        </div>
        {# ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ #}
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
</div>

{# --- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}
{# --- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ã“ã“ã¾ã§ --- #}

{# --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º --- #}
<div class="row g-4">
    {# --- è»Šä¸¡ä¸€è¦§ --- #}
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-motorcycle me-1"></i> ç™»éŒ²è»Šä¸¡
            </div>
            <div class="card-body">
                {% if motorcycles %}
                    <ul class="list-group list-group-flush">
                        {% for motorcycle in motorcycles %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    {% if motorcycle.is_default %}<i class="fas fa-star text-warning me-1" title="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè»Šä¸¡"></i>{% endif %}
                                    <strong>{{ motorcycle.name }}</strong>
                                    <small class="text-muted">({{ motorcycle.maker or 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜' }} / {{ motorcycle.year or 'å¹´å¼ä¸æ˜' }})</small>
                                    <br>
                                    <small class="text-info">
                                        {# å¹³å‡ç‡ƒè²»ã¯ view é–¢æ•°å´ã§è¨ˆç®—ã—ã¦æ¸¡ã™æƒ³å®š (ä¾‹: motorcycle._average_kpl) #}
                                        {% if motorcycle._average_kpl is defined and motorcycle._average_kpl is not none %}
                                            <i class="fas fa-tachometer-alt me-1"></i> å¹³å‡ç‡ƒè²»: <strong>{{"%.2f"|format(motorcycle._average_kpl)}}</strong> km/L
                                        {% else %}
                                            {# <i class="fas fa-info-circle me-1"></i> (å¹³å‡ç‡ƒè²» è¨ˆç®—ä¸å¯: è¨˜éŒ²ä¸è¶³) #}
                                            {# ã‚ã‚‹ã„ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ #}
                                        {% endif %}
                                    </small>
                                </span>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('fuel.add_fuel', motorcycle_id=motorcycle.id) }}" class="btn btn-outline-success" title="ã“ã®è»Šä¸¡ã®çµ¦æ²¹è¨˜éŒ²ã‚’è¿½åŠ "><i class="fas fa-gas-pump"></i></a>
                                    <a href="{{ url_for('maintenance.add_maintenance', motorcycle_id=motorcycle.id) }}" class="btn btn-outline-warning" title="ã“ã®è»Šä¸¡ã®æ•´å‚™è¨˜éŒ²ã‚’è¿½åŠ "><i class="fas fa-tools"></i></a>
                                    <a href="{{ url_for('vehicle.edit_vehicle', vehicle_id=motorcycle.id) }}" class="btn btn-outline-secondary" title="è»Šä¸¡æƒ…å ±ã‚’ç·¨é›†"><i class="fas fa-edit"></i></a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="card-text text-muted">è»Šä¸¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                {% endif %}
                 <div class="mt-3">
                     <a href="{{ url_for('vehicle.add_vehicle') }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-plus me-1"></i> è»Šä¸¡ã‚’è¿½åŠ </a>
                 </div>
            </div>
        </div>
    </div>

    {# --- ç›´è¿‘ã®çµ¦æ²¹è¨˜éŒ² --- #}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><i class="fas fa-gas-pump me-1"></i> ç›´è¿‘ã®çµ¦æ²¹è¨˜éŒ²</div>
            <div class="card-body">
                {# recent_fuel_entries ã¯ view é–¢æ•°ã‹ã‚‰æ¸¡ã™æƒ³å®š #}
                {% if recent_fuel_entries %}
                    <ul class="list-group list-group-flush">
                        {% for entry in recent_fuel_entries %}
                            <li class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ entry.motorcycle.name }} <small class="text-muted">@ {{ entry.odometer_reading }} km</small></h6>
                                    <small>{{ entry.entry_date.strftime('%Y-%m-%d') }}</small>
                                </div>
                                <p class="mb-1">
                                    çµ¦æ²¹é‡: {{ entry.fuel_volume }} L
                                    {% if entry.km_per_liter is not none %}| ç‡ƒè²»: {{ "%.2f"|format(entry.km_per_liter) }} km/L{% endif %}
                                    {% if entry.total_cost is not none %}| é‡‘é¡: {{ entry.total_cost|round|int }} å††{% endif %}
                                </p>
                                <small class="text-muted">{{ entry.station_name or 'ã‚¹ã‚¿ãƒ³ãƒ‰åæœªè¨˜éŒ²' }}</small>
                                <a href="{{ url_for('fuel.edit_fuel', entry_id=entry.id) }}" class="btn btn-sm btn-outline-secondary float-end"><i class="fas fa-edit"></i></a>
                            </li>
                        {% endfor %}
                    </ul>
                     <div class="mt-3">
                         <a href="{{ url_for('fuel.fuel_log') }}" class="btn btn-sm btn-outline-secondary">å…¨çµ¦æ²¹è¨˜éŒ²ã‚’è¦‹ã‚‹</a>
                     </div>
                {% else %}
                    <p class="card-text text-muted">çµ¦æ²¹è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# --- ç›´è¿‘ã®æ•´å‚™è¨˜éŒ² --- #}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><i class="fas fa-tools me-1"></i> ç›´è¿‘ã®æ•´å‚™è¨˜éŒ²</div>
            <div class="card-body">
                 {# recent_maintenance_entries ã¯ view é–¢æ•°ã‹ã‚‰æ¸¡ã™æƒ³å®š #}
                {% if recent_maintenance_entries %}
                    <ul class="list-group list-group-flush">
                        {% for entry in recent_maintenance_entries %}
                            <li class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                     <h6 class="mb-1">{{ entry.motorcycle.name }} <small class="text-muted">@ {{ entry.odometer_reading_at_maintenance }} km</small></h6>
                                    <small>{{ entry.maintenance_date.strftime('%Y-%m-%d') }}</small>
                                </div>
                                <p class="mb-1">
                                    å†…å®¹: {{ entry.description | truncate(50) }}
                                    {% if entry.total_cost %}| è²»ç”¨: {{ entry.total_cost|round|int }} å††{% endif %}
                                </p>
                                <small class="text-muted">ã‚«ãƒ†ã‚´ãƒª: {{ entry.category or 'æœªåˆ†é¡' }}</small>
                                <a href="{{ url_for('maintenance.edit_maintenance', entry_id=entry.id) }}" class="btn btn-sm btn-outline-secondary float-end"><i class="fas fa-edit"></i></a>
                            </li>
                        {% endfor %}
                    </ul>
                     <div class="mt-3">
                         <a href="{{ url_for('maintenance.maintenance_log') }}" class="btn btn-sm btn-outline-secondary">å…¨æ•´å‚™è¨˜éŒ²ã‚’è¦‹ã‚‹</a>
                     </div>
                {% else %}
                    <p class="card-text text-muted">æ•´å‚™è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                {% endif %}
            </div>
        </div>
    </div>

</div>{# End row #}

{# --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ --- #}
<div class="mt-4 pt-4 border-top">
    <h2>è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div id='calendar'></div> {# ã“ã“ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæç”»ã•ã‚Œã‚‹ #}
</div>

{% endblock %}

{# --- JavaScript --- #}
{% block scripts %}
{{ super() }} {# base.html ã® scripts ãƒ–ãƒ­ãƒƒã‚¯ã®å†…å®¹ã‚’å¼•ãç¶™ã #}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹è¦ç´ ã‚’å–å¾—
    var calendarEl = document.getElementById('calendar');

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— (ç°¡æ˜“ç‰ˆ)
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe; // æ–‡å­—åˆ—ä»¥å¤–ã¯ãã®ã¾ã¾è¿”ã™
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    if (calendarEl) { // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿åˆæœŸåŒ–
        // FullCalendar ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆãƒ»è¨­å®š
        var calendar = new FullCalendar.Calendar(calendarEl, {
          // --- åŸºæœ¬è¨­å®š ---
          initialView: 'dayGridMonth',
          locale: 'ja',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,dayGridWeek'
          },
          buttonText: {
              today:    'ä»Šæ—¥',
              month:    'æœˆ',
              week:     'é€±',
          },
          contentHeight: 'auto',

          // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®š ---
          events: '/api/dashboard/events',

          // --- ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ ---
          eventClick: function(info) {
            info.jsEvent.preventDefault();
            if (info.event.url) {
              window.location.href = info.event.url;
            }
          },

          // â–¼â–¼â–¼ ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤ºã®ãŸã‚ã® eventDidMount ã‚’è¿½åŠ  â–¼â–¼â–¼
          eventDidMount: function(info) {
            // APIã‹ã‚‰ extendedProps ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
            if (info.event.extendedProps) {
              var props = info.event.extendedProps; // è©³ç´°æƒ…å ±
              var popoverTitle = '';             // ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«
              var popoverContent = '';           // ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã®å†…å®¹ (HTML)

              // --- ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã®å†…å®¹ã‚’ç”Ÿæˆ ---
              // æ—¥æœ¬èªå½¢å¼ã§æ—¥ä»˜è¡¨ç¤º (ä¾‹: 2025/5/4) - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«æ³¨æ„ãŒå¿…è¦ãªå ´åˆã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œè¨
              var dateString = info.event.start ? info.event.start.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }) : 'æ—¥ä»˜ä¸æ˜';

              // è¨˜éŒ²ã‚¿ã‚¤ãƒ— (type) ã«å¿œã˜ã¦å†…å®¹ã‚’åˆ†å²
              if (props.type === 'fuel') {
                popoverTitle = `â›½ çµ¦æ²¹ (${props.motorcycleName || 'è»Šä¸¡ä¸æ˜'})`;
                popoverContent = `
                  <strong>æ—¥ä»˜:</strong> ${dateString}<br>
                  <strong>ãƒ¡ãƒ¼ã‚¿ãƒ¼:</strong> ${props.odometer != null ? props.odometer + ' km' : 'æœªè¨˜éŒ²'}<br>
                  <strong>çµ¦æ²¹é‡:</strong> ${props.fuelVolume != null ? props.fuelVolume.toFixed(2) + ' L' : 'æœªè¨˜éŒ²'}<br>
                  <strong>ç‡ƒè²»:</strong> ${props.kmPerLiter || 'è¨ˆç®—ä¸å¯'}<br>
                  <strong>é‡‘é¡:</strong> ${props.totalCost != null ? props.totalCost + ' å††' : 'æœªè¨˜éŒ²'}<br>
                  <strong>ã‚¹ã‚¿ãƒ³ãƒ‰:</strong> ${props.stationName || 'æœªè¨˜éŒ²'}<br>
                  ${props.notes ? '<hr class="my-1"><strong>ãƒ¡ãƒ¢:</strong><br>' + escapeHtml(props.notes).replace(/\n/g, '<br>').substring(0, 150) + (props.notes.length > 150 ? '...' : '') : ''}
                `;
              } else if (props.type === 'maintenance') {
                popoverTitle = `ğŸ”§ ${props.category || 'æ•´å‚™'} (${props.motorcycleName || 'è»Šä¸¡ä¸æ˜'})`;
                popoverContent = `
                  <strong>æ—¥ä»˜:</strong> ${dateString}<br>
                  <strong>ãƒ¡ãƒ¼ã‚¿ãƒ¼:</strong> ${props.odometer != null ? props.odometer + ' km' : 'æœªè¨˜éŒ²'}<br>
                  <strong>å†…å®¹:</strong> ${props.description ? escapeHtml(props.description).replace(/\n/g, '<br>') : 'æœªè¨˜éŒ²'}<br>
                  <strong>è²»ç”¨:</strong> ${props.totalCost != null ? props.totalCost + ' å††' : 'æœªè¨˜éŒ²'}<br>
                  <strong>å ´æ‰€:</strong> ${props.location || 'æœªè¨˜éŒ²'}<br>
                  ${props.notes ? '<hr class="my-1"><strong>ãƒ¡ãƒ¢:</strong><br>' + escapeHtml(props.notes).replace(/\n/g, '<br>').substring(0, 150) + (props.notes.length > 150 ? '...' : '') : ''}
                `;
              }

              // --- Bootstrap Popover ã‚’åˆæœŸåŒ– ---
              if (popoverTitle && popoverContent) {
                 // PopoverãŒé‡è¤‡ã—ã¦åˆæœŸåŒ–ã•ã‚Œã‚‹ã®ã‚’é˜²ã (å¿µã®ãŸã‚)
                 if (!info.el.hasAttribute('data-bs-toggle')) {
                   var popover = new bootstrap.Popover(info.el, {
                    title: popoverTitle,
                    content: popoverContent,
                    trigger: 'hover',      // ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§è¡¨ç¤ºãƒ»éè¡¨ç¤º
                    placement: 'auto',     // è‡ªå‹•ã§æœ€é©ãªä½ç½®ã«è¡¨ç¤º
                    boundary: 'viewport',  // è¡¨ç¤ºé ˜åŸŸã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«åˆ¶é™
                    html: true,         // content å†…ã® HTML ã‚’æœ‰åŠ¹åŒ–
                    sanitize: false,      // HTML ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ false (escapeHtmlã§å¯¾ç­–)
                    container: 'body',    // PopoverãŒã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¤–ã«æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«
                    customClass: 'motopuppu-popover' // ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ (ä»»æ„)
                  });
                 }
              }
            }
          }
          // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
        });

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
        calendar.render();
    } else {
        console.error("Calendar element not found");
    }
  });
</script>
{% endblock %}