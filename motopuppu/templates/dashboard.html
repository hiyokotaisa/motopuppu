{# motopuppu/templates/dashboard.html #}
{% extends "base.html" %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ã‚‚ã¨ã·ã£ã·ãƒ¼{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .dashboard-timeline {
        list-style: none;
        padding: 0;
        position: relative;
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding-left: 50px;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 18px;
        top: 20px;
        bottom: -1.5rem;
        width: 4px;
        background-color: #e9ecef;
        z-index: 1;
    }
    .timeline-item:last-child::before {
        display: none;
    }
    .timeline-item-marker {
        position: absolute;
        top: 0;
        left: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #fff;
        border: 4px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        z-index: 10;
    }
    .timeline-item-marker.type-fuel {
        color: #198754;
        border-color: #198754;
    }
    .timeline-item-marker.type-maintenance {
        color: #ffc107;
        border-color: #ffc107;
    }
    .timeline-item-content {
        position: relative;
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        border: 1px solid #e9ecef;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }
    .timeline-item-content:hover {
        background-color: #f1f3f5;
        border-color: #dee2e6;
    }
    .timeline-item-date {
        font-weight: 600;
        font-size: 0.9rem;
        color: #6c757d;
    }
    .timeline-item-title {
        font-weight: 600;
        margin-bottom: 0.1rem;
        color: #212529;
    }
    .timeline-item-description {
        font-size: 0.9rem;
        color: #495057;
    }
    .timeline-item-cost {
        font-size: 0.85rem;
        color: #6c757d;
    }
    #timelineDetailModal .modal-header .icon-fuel { color: #198754; }
    #timelineDetailModal .modal-header .icon-maintenance { color: #ffc107; }

    /* ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã®æœ€å¤§å¹…ãªã© */
    .motopuppu-popover {
        max-width: 350px;
    }
    /* æ—¥ä»˜ã‚»ãƒ«ã®é«˜ã•ã‚’å°‘ã—ç¢ºä¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãŒå¤šã„ã¨ãã«è¦‹ã‚„ã™ãï¼‰ */
    .fc-daygrid-day-frame {
        min-height: 100px;
    }
    /* ç¥æ—¥ã®èƒŒæ™¯è‰²ãªã© */
    .fc .fc-daygrid-day.fc-day-holiday {
        background-color: rgba(255, 0, 0, 0.05);
    }
    /* åœŸæ—¥ã®æ—¥ä»˜ç•ªå·ã®è‰² */
    .fc .fc-daygrid-day-number.is-sat {
        color: #0d6efd;
    }
    .fc .fc-daygrid-day-number.is-sun, .fc .fc-daygrid-day-number.is-holiday {
        color: #dc3545;
    }
    /* ç¥æ—¥å */
    .fc-holiday-name {
        display: block;
        font-size: 0.7em;
        text-align: center;
        color: #dc3545;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        padding: 0 2px;
        margin-top: -2px;
    }
    /* TODOãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .motopuppu-popover .list-unstyled li {
        margin-bottom: 0.2rem;
    }
    .motopuppu-popover .list-unstyled label {
        vertical-align: middle;
        word-break: break-word;
    }
    .motopuppu-popover .form-check-input {
        margin-top: 0.1em;
        cursor: default;
    }
    /* ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .widget-grab-handle {
        cursor: grab;
        display: none; /* é€šå¸¸æ™‚ã¯éè¡¨ç¤º */
    }
    .sortable-ghost {
        opacity: 0.4;
        background: #c8ebfb;
    }
    #dashboard-widgets-container.is-sorting .widget-grab-handle {
        display: inline-block;
    }
    #dashboard-widgets-container.is-sorting .card-header {
        background-color: #f0f8ff; /* ä¸¦ã³æ›¿ãˆä¸­ã¯ãƒ˜ãƒƒãƒ€ãƒ¼è‰²ã‚’å°‘ã—å¤‰ãˆã‚‹ */
    }
</style>
{% endblock %}

{% block content %}
{# --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- #}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{% if current_user.is_authenticated %}ã‚ˆã†ã“ãã€{{ current_user.display_name or current_user.misskey_username }}ã•ã‚“{% else %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endif %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div id="layout-buttons-default" class="me-2">
            {# â–¼â–¼â–¼ å¤‰æ›´ç®‡æ‰€ â–¼â–¼â–¼ #}
            <button id="edit-layout-btn" type="button" class="btn btn-sm btn-outline-secondary" title="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç·¨é›†" aria-label="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç·¨é›†">
                <i class="bi bi-gear-fill"></i>
            </button>
            {# â–²â–²â–² å¤‰æ›´ã“ã“ã¾ã§ â–²â–²â–² #}
        </div>
        <div id="layout-buttons-editing" class="btn-group me-2" style="display: none;">
            <button id="save-layout-btn" type="button" class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i> ä¿å­˜</button>
            <button id="reset-layout-btn" type="button" class="btn btn-sm btn-info text-white"><i class="fas fa-undo me-1"></i> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            <button id="cancel-layout-btn" type="button" class="btn btn-sm btn-secondary"><i class="fas fa-times me-1"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('fuel.add_fuel') }}" class="btn btn-sm btn-success"><i class="fas fa-gas-pump me-1"></i> çµ¦æ²¹è¨˜éŒ²ã‚’è¿½åŠ </a>
            <a href="{{ url_for('maintenance.add_maintenance') }}" class="btn btn-sm btn-warning text-white"><i class="fas fa-tools me-1"></i> æ•´å‚™è¨˜éŒ²ã‚’è¿½åŠ </a>
            <a href="{{ url_for('notes.add_note') }}" class="btn btn-sm btn-primary"><i class="fas fa-sticky-note me-1"></i> ãƒãƒ¼ãƒˆã‚’è¿½åŠ </a>
        </div>
    </div>
</div>

{# --- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message | safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{# â–¼â–¼â–¼ accordionã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ  â–¼â–¼â–¼ #}
<div id="dashboard-widgets-container" class="accordion dashboard-widgets">
    {% for widget_name in dashboard_layout %}
        {% if widget_name == 'reminders' %}
            {% include 'dashboard/_reminders_widget.html' %}
        {% elif widget_name == 'stats' %}
            {% include 'dashboard/_stats_widget.html' %}
        {% elif widget_name == 'vehicles' %}
            {% include 'dashboard/_vehicles_widget.html' %}
        {% elif widget_name == 'timeline' %}
            {% include 'dashboard/_timeline_widget.html' %}
        {# â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰è¿½è¨˜ã€‘â–¼â–¼â–¼ #}
        {% elif widget_name == 'circuit' %}
            {% include 'dashboard/_circuit_widget.html' %}
        {# â–²â–²â–²ã€è¿½è¨˜ã¯ã“ã“ã¾ã§ã€‘â–²â–²â–² #}
        {% elif widget_name == 'calendar' %}
            {% include 'dashboard/_calendar_widget.html' %}
        {% endif %}
    {% endfor %}
</div>

<div class="modal fade" id="timelineDetailModal" tabindex="-1" aria-labelledby="timelineDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="timelineDetailModalLabel">
            <span id="modal-icon-placeholder"></span>
            <span id="modal-title-placeholder"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
            <dt class="col-sm-4">æ—¥ä»˜</dt>
            <dd class="col-sm-8" id="modal-date"></dd>

            <dt class="col-sm-4">ODOãƒ¡ãƒ¼ã‚¿ãƒ¼</dt>
            <dd class="col-sm-8" id="modal-odo"></dd>
        </dl>
        <hr>
        <dl class="row" id="modal-details-container"></dl>
      </div>
      <div class="modal-footer">
        <a href="#" id="modal-edit-button" class="btn btn-primary">ç·¨é›†ã™ã‚‹</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# â–¼â–¼â–¼ã€é‡è¦ã€‘ã“ã®è¡Œã‚’è¿½åŠ ã—ã¦ã€FullCalendarãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ã¾ã™ â–¼â–¼â–¼ #}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
{# â–²â–²â–² è¿½åŠ ã¯ã“ã“ã¾ã§ â–²â–²â–² #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ ---
    const widgetsContainer = document.getElementById('dashboard-widgets-container');
    const editBtn = document.getElementById('edit-layout-btn');
    const saveBtn = document.getElementById('save-layout-btn');
    const cancelBtn = document.getElementById('cancel-layout-btn');
    const resetBtn = document.getElementById('reset-layout-btn');
    const defaultButtons = document.getElementById('layout-buttons-default');
    const editingButtons = document.getElementById('layout-buttons-editing');
    
    let sortable = null;
    let originalOrder = [];
    const defaultOrder = ['reminders', 'stats', 'vehicles', 'timeline', 'circuit', 'calendar'];

    const reorderWidgets = (order) => {
        const fragment = document.createDocumentFragment();
        order.forEach(widgetName => {
            const widgetEl = widgetsContainer.querySelector(`[data-widget-name="${widgetName}"]`);
            if (widgetEl) {
                fragment.appendChild(widgetEl);
            }
        });
        widgetsContainer.innerHTML = '';
        widgetsContainer.appendChild(fragment);
    };

    // ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
    editBtn.addEventListener('click', function() {
        originalOrder = Array.from(widgetsContainer.children).map(el => el.dataset.widgetName);

        widgetsContainer.classList.add('is-sorting');
        defaultButtons.style.display = 'none';
        editingButtons.style.display = 'inline-flex';

        sortable = new Sortable(widgetsContainer, {
            animation: 150,
            handle: '.widget-grab-handle',
            ghostClass: 'sortable-ghost',
        });
    });

    const endEditingMode = () => {
        if (sortable) {
            sortable.destroy();
            sortable = null;
        }
        widgetsContainer.classList.remove('is-sorting');
        defaultButtons.style.display = 'block';
        editingButtons.style.display = 'none';
    };

    // å¤‰æ›´ã‚’ä¿å­˜
    saveBtn.addEventListener('click', function() {
        // â–¼â–¼â–¼ å¤‰æ›´ãƒ»è¿½è¨˜ â–¼â–¼â–¼
        // sortable.toArray() ã®ä»£ã‚ã‚Šã«ã€DOMã‹ã‚‰ç›´æ¥data-widget-nameå±æ€§ã‚’èª­ã¿å–ã‚‹
        const newOrder = Array.from(widgetsContainer.children).map(el => el.dataset.widgetName);
        // â–²â–²â–² å¤‰æ›´ãƒ»è¿½è¨˜ ã“ã“ã¾ã§ â–²â–²â–²

        const csrfTokenEl = document.querySelector('meta[name="csrf-token"]');
        if (!csrfTokenEl) {
            alert('ã‚¨ãƒ©ãƒ¼: CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚base.htmlã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        const csrfToken = csrfTokenEl.getAttribute('content');

        fetch("{{ url_for('main.save_dashboard_layout') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ layout: newOrder })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('Failed to save layout:', data.message);
                alert('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        })
        .finally(() => {
            endEditingMode();
        });
    });
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
    resetBtn.addEventListener('click', function() {
        reorderWidgets(defaultOrder);
    });

    // å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    cancelBtn.addEventListener('click', function() {
        reorderWidgets(originalOrder);
        endEditingMode();
    });

    // --- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ ---
    const filterButtons = document.getElementById('timeline-filter-buttons');
    if (filterButtons) {
        filterButtons.addEventListener('click', function(e) {
            const button = e.target.closest('button');
            if (button) {
                const filter = button.dataset.filter;
                
                filterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.querySelectorAll('.timeline-item').forEach(item => {
                    if (filter === 'all' || item.dataset.eventType === filter) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        });
    }

    const timelineDetailModal = document.getElementById('timelineDetailModal');
    if (timelineDetailModal) {
        timelineDetailModal.addEventListener('show.bs.modal', function (event) {
            const item = event.relatedTarget;
            const eventType = item.dataset.eventType;
            const details = JSON.parse(item.dataset.eventDetails);
            const editUrl = item.dataset.eventEditUrl;
            
            const modalTitle = timelineDetailModal.querySelector('#modal-title-placeholder');
            const modalIcon = timelineDetailModal.querySelector('#modal-icon-placeholder');
            const modalDate = timelineDetailModal.querySelector('#modal-date');
            const modalOdo = timelineDetailModal.querySelector('#modal-odo');
            const modalDetailsContainer = timelineDetailModal.querySelector('#modal-details-container');
            const modalEditButton = timelineDetailModal.querySelector('#modal-edit-button');

            if (eventType === 'fuel') {
                modalIcon.innerHTML = '<i class="fas fa-gas-pump icon-fuel"></i>';
                modalTitle.textContent = 'çµ¦æ²¹è¨˜éŒ²è©³ç´°';
            } else if (eventType === 'maintenance') {
                modalIcon.innerHTML = '<i class="fas fa-tools icon-maintenance"></i>';
                modalTitle.textContent = 'æ•´å‚™è¨˜éŒ²è©³ç´°';
            }

            modalDate.textContent = item.dataset.eventDate;
            modalOdo.textContent = `${parseInt(item.dataset.eventOdo).toLocaleString()} km`;

            modalDetailsContainer.innerHTML = '';
            for (const [key, value] of Object.entries(details)) {
                if (key === 'è»Šä¸¡å') {
                   const selectedVehicle = document.querySelector('select[name="timeline_vehicle_id"]');
                   if (selectedVehicle && selectedVehicle.value !== 'all') continue;
                }

                const dt = document.createElement('dt');
                dt.className = 'col-sm-4';
                dt.textContent = key;
                const dd = document.createElement('dd');
                dd.className = 'col-sm-8';
                dd.textContent = value;
                modalDetailsContainer.appendChild(dt);
                modalDetailsContainer.appendChild(dd);
            }
            
            modalEditButton.href = editUrl;
        });
    }
    
    // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ ---
    var calendarEl = document.getElementById('calendar');
    // (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®JSã¯é•·ã„ãŸã‚ã€å¤‰æ›´ãŒãªã„ã®ã§ã“ã“ã§ã¯çœç•¥ã—ã¾ã™)
    // ... æ—¢å­˜ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼JSã‚³ãƒ¼ãƒ‰ ...
    let holidaysMap = {};
    try {
        const holidaysData = JSON.parse('{{ holidays_json | safe }}');
        if (typeof holidaysData === 'object' && holidaysData !== null) {
            holidaysMap = holidaysData;
        } else {
            console.error("Invalid holidays data format:", holidaysData);
        }
    } catch (e) {
        console.error("Error parsing holidays JSON:", e);
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    if (calendarEl) {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek,listMonth'
            },
            buttonText: {
                today: 'ä»Šæ—¥',
                month: 'æœˆ',
                week: 'é€±',
                list: 'ãƒªã‚¹ãƒˆ(æœˆ)'
            },
            contentHeight: 'auto',
            dayCellContent: function(arg) {
                return { html: `<span class="fc-daygrid-day-number">${arg.date.getDate()}</span>` };
            },
            dayCellDidMount: function(arg) {
                const year = arg.date.getFullYear();
                const month = (arg.date.getMonth() + 1).toString().padStart(2, '0');
                const day = arg.date.getDate().toString().padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                const dayNumberEl = arg.el.querySelector('.fc-daygrid-day-number');
                const dayTopEl = arg.el.querySelector('.fc-daygrid-day-top');
                const dayOfWeek = arg.date.getDay();

                if (!dayNumberEl || !dayTopEl) return;
                
                arg.el.classList.remove('fc-day-holiday', 'fc-day-sun', 'fc-day-sat');
                dayNumberEl.classList.remove('is-holiday', 'is-sun', 'is-sat');
                
                const existingHolidayName = dayTopEl.querySelector('.fc-holiday-name');
                if (existingHolidayName) {
                    dayTopEl.removeChild(existingHolidayName);
                }
                
                if (holidaysMap.hasOwnProperty(dateStr)) {
                    const holidayName = holidaysMap[dateStr];
                    const holidayNameEl = document.createElement('span');
                    holidayNameEl.classList.add('fc-holiday-name');
                    holidayNameEl.textContent = holidayName;
                    dayTopEl.appendChild(holidayNameEl);
                    arg.el.classList.add('fc-day-holiday');
                    dayNumberEl.classList.add('is-holiday');
                } else if (dayOfWeek === 0) { // Sunday
                    arg.el.classList.add('fc-day-sun');
                    dayNumberEl.classList.add('is-sun');
                } else if (dayOfWeek === 6) { // Saturday
                    arg.el.classList.add('fc-day-sat');
                    dayNumberEl.classList.add('is-sat');
                }
            },
            events: '/api/dashboard/events',
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                const editUrl = info.event.extendedProps?.editUrl || info.event.url;
                if (editUrl) {
                    window.location.href = editUrl;
                }
            },
            eventDidMount: function(info) {
                if (info.event.extendedProps) {
                    var props = info.event.extendedProps;
                    var popoverTitle = '';
                    var popoverContent = '';

                    var eventDateStr = 'æ—¥ä»˜ä¸æ˜';
                    if (info.event.start) {
                        try {
                            eventDateStr = info.event.start.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
                        } catch (e) {
                            eventDateStr = info.event.start.toISOString().split('T')[0];
                            console.warn("toLocaleDateString failed, using fallback date format:", eventDateStr, e);
                        }
                    }

                    var editUrl = props.editUrl;

                    if (props.type === 'fuel') {
                        popoverTitle = `â›½ çµ¦æ²¹ (${escapeHtml(props.motorcycleName || 'è»Šä¸¡ä¸æ˜')})`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>æ—¥ä»˜:</dt><dd>${escapeHtml(eventDateStr)}</dd>` +
                            `<dt>ODO:</dt><dd>${props.odometer ? escapeHtml(props.odometer.toLocaleString()) + ' km' : '-'}</dd>` +
                            `<dt>çµ¦æ²¹é‡:</dt><dd>${props.fuelVolume ? escapeHtml(props.fuelVolume.toFixed(2)) + ' L' : '-'}</dd>` +
                            `<dt>ç‡ƒè²»:</dt><dd>${props.kmPerLiter || '-'}</dd>` +
                            `<dt>é‡‘é¡:</dt><dd>${props.totalCost ? escapeHtml(props.totalCost.toLocaleString()) + ' å††' : '-'}</dd>` +
                            (props.stationName ? `<dt>ã‚¹ã‚¿ãƒ³ãƒ‰:</dt><dd>${escapeHtml(props.stationName)}</dd>` : '') +
                            (props.notes ? `<dt>ãƒ¡ãƒ¢:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.notes)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'maintenance') {
                        popoverTitle = `ğŸ”§ ${escapeHtml(props.category || 'æ•´å‚™')} (${escapeHtml(props.motorcycleName || 'è»Šä¸¡ä¸æ˜')})`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>æ—¥ä»˜:</dt><dd>${escapeHtml(eventDateStr)}</dd>` +
                            `<dt>ODO:</dt><dd>${props.odometer ? escapeHtml(props.odometer.toLocaleString()) + ' km' : '-'}</dd>` +
                            `<dt>å†…å®¹:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.description || 'è¨˜è¼‰ãªã—')}</dd>` +
                            (props.category ? `<dt>ã‚«ãƒ†ã‚´ãƒª:</dt><dd>${escapeHtml(props.category)}</dd>` : '') +
                            `<dt>è²»ç”¨:</dt><dd>${props.totalCost ? escapeHtml(props.totalCost.toLocaleString()) + ' å††' : '-'}</dd>` +
                            (props.location ? `<dt>å ´æ‰€:</dt><dd>${escapeHtml(props.location)}</dd>` : '') +
                            (props.notes ? `<dt>ãƒ¡ãƒ¢:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.notes)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'activity') {
                        let racerBadge = props.isRacer ? ' <span class="badge bg-info text-dark small">ãƒ¬ãƒ¼ã‚µãƒ¼</span>' : '';
                        popoverTitle = `ğŸ ${escapeHtml(props.activityTitle)} (${escapeHtml(props.motorcycleName || 'è»Šä¸¡ä¸æ˜')}${racerBadge})`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>æ—¥ä»˜:</dt><dd>${escapeHtml(eventDateStr)}</dd>` +
                            `<dt>å ´æ‰€:</dt><dd>${escapeHtml(props.location || 'æœªè¨­å®š')}</dd>` +
                            (props.weather ? `<dt>å¤©å€™:</dt><dd>${escapeHtml(props.weather)}</dd>` : '') +
                            (props.temperature ? `<dt>æ°—æ¸©:</dt><dd>${escapeHtml(props.temperature)}</dd>` : '') +
                            (props.notes ? `<dt>ãƒ¡ãƒ¢:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.notes)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'note') {
                        let noteTitle = props.title || '(ç„¡é¡Œã®ãƒãƒ¼ãƒˆ)';
                        let racerBadge = props.isRacer ? ' <span class="badge bg-info text-dark small">ãƒ¬ãƒ¼ã‚µãƒ¼</span>' : '';
                        popoverTitle = `ğŸ“ ãƒãƒ¼ãƒˆ ${props.motorcycleName ? '(' + escapeHtml(props.motorcycleName) + racerBadge + ')' : ''}`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>æ—¥ä»˜:</dt><dd>${escapeHtml(props.noteDate || eventDateStr)}</dd>` +
                            `<dt>ã‚¿ã‚¤ãƒˆãƒ«:</dt><dd>${escapeHtml(noteTitle)}</dd>` +
                            `<dt>å†…å®¹:</dt><dd style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(props.content || 'è¨˜è¼‰ãªã—')}</dd>` +
                            (props.motorcycleName ? `<dt>é–¢é€£è»Šä¸¡:</dt><dd>${escapeHtml(props.motorcycleName)}</dd>` : '') +
                            (props.createdAt ? `<dt>ä½œæˆ:</dt><dd>${escapeHtml(props.createdAt)}</dd>` : '') +
                            (props.updatedAt ? `<dt>æ›´æ–°:</dt><dd>${escapeHtml(props.updatedAt)}</dd>` : '') +
                            `</dl>`;
                    } else if (props.type === 'task') {
                        let taskTitle = props.title || '(ç„¡é¡Œã®ã‚¿ã‚¹ã‚¯)';
                        let racerBadge = props.isRacer ? ' <span class="badge bg-info text-dark small">ãƒ¬ãƒ¼ã‚µãƒ¼</span>' : '';
                        popoverTitle = `âœ… ã‚¿ã‚¹ã‚¯ ${props.motorcycleName ? '(' + escapeHtml(props.motorcycleName) + racerBadge + ')' : ''}`;
                        popoverContent = `<dl class="mb-0 small">` +
                            `<dt>æ—¥ä»˜:</dt><dd>${escapeHtml(props.noteDate || eventDateStr)}</dd>` +
                            `<dt>ã‚¿ã‚¤ãƒˆãƒ«:</dt><dd>${escapeHtml(taskTitle)}</dd>` +
                            (props.motorcycleName ? `<dt>é–¢é€£è»Šä¸¡:</dt><dd>${escapeHtml(props.motorcycleName)}</dd>` : '') +
                            '<dt>TODO:</dt><dd>';
                        if (props.todos && Array.isArray(props.todos) && props.todos.length > 0) {
                            popoverContent += '<ul class="list-unstyled mb-0 small ps-1">';
                            props.todos.forEach(function(todo, index) {
                                const isChecked = todo && todo.checked;
                                const text = todo && todo.text ? escapeHtml(todo.text) : '(ç©º)';
                                const checkboxId = `todo-${info.event.id}-${index}`;
                                popoverContent += `<li class="d-flex align-items-center">` +
                                    `<input type="checkbox" id="${checkboxId}" disabled ${isChecked ? 'checked' : ''} class="form-check-input me-1">` +
                                    `<label for="${checkboxId}" class="${isChecked ? 'text-decoration-line-through text-muted' : ''}">${text}</label>` +
                                    `</li>`;
                            });
                            popoverContent += '</ul>';
                        } else {
                            popoverContent += '<span class="text-muted">TODOã¯ã‚ã‚Šã¾ã›ã‚“</span>';
                        }
                        popoverContent += '</dd>';
                        popoverContent += (props.createdAt ? `<dt>ä½œæˆ:</dt><dd>${escapeHtml(props.createdAt)}</dd>` : '') +
                                        (props.updatedAt ? `<dt>æ›´æ–°:</dt><dd>${escapeHtml(props.updatedAt)}</dd>` : '');
                        popoverContent += `</dl>`;
                    }

                    if (editUrl) {
                        popoverContent += `<a href="${escapeHtml(editUrl)}" class="btn btn-sm btn-outline-primary mt-2 py-0 px-1" title="ç·¨é›†"><i class="fas fa-edit fa-xs me-1"></i>ç·¨é›†</a>`;
                    }
                    
                    if (popoverTitle && popoverContent) {
                        var popover = new bootstrap.Popover(info.el, {
                            title: popoverTitle,
                            content: popoverContent,
                            trigger: 'hover focus',
                            placement: 'auto',
                            boundary: 'viewport',
                            html: true,
                            sanitize: false,
                            container: 'body',
                            customClass: 'motopuppu-popover'
                        });
                        info.el.addEventListener('remove', () => {
                            if(popover) {
                                popover.dispose();
                            }
                        });
                    }
                }
            }
        });
        calendar.render();
    } else {
        console.error("Calendar element (#calendar) not found");
    }

// â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰è¿½è¨˜ã€‘ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé–‹é–‰çŠ¶æ…‹ã®ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½ â–¼â–¼â–¼
    const WIDGET_STATE_KEY = 'dashboardWidgetStates';

    // localStorageã‹ã‚‰çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã€ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã«é©ç”¨ã™ã‚‹é–¢æ•°
    const applyWidgetStates = () => {
        const savedStatesJSON = localStorage.getItem(WIDGET_STATE_KEY);
        if (!savedStatesJSON) {
            return; // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
        }
        
        try {
            const savedStates = JSON.parse(savedStatesJSON);
            const widgets = widgetsContainer.querySelectorAll('.accordion-item');

            widgets.forEach(widget => {
                const widgetName = widget.dataset.widgetName;
                if (widgetName in savedStates) {
                    const shouldBeOpen = savedStates[widgetName];
                    const collapseElement = widget.querySelector('.accordion-collapse');
                    const button = widget.querySelector('.accordion-button');

                    if (shouldBeOpen) {
                        collapseElement.classList.add('show');
                        button.classList.remove('collapsed');
                        button.setAttribute('aria-expanded', 'true');
                    } else {
                        collapseElement.classList.remove('show');
                        button.classList.add('collapsed');
                        button.setAttribute('aria-expanded', 'false');
                    }
                }
            });
        } catch (e) {
            console.error('Failed to parse widget states from localStorage', e);
            localStorage.removeItem(WIDGET_STATE_KEY); // ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        }
    };

    // ç¾åœ¨ã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®çŠ¶æ…‹ã‚’localStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
    const saveWidgetStates = () => {
        const states = {};
        const widgets = widgetsContainer.querySelectorAll('.accordion-item');
        widgets.forEach(widget => {
            const widgetName = widget.dataset.widgetName;
            const collapseElement = widget.querySelector('.accordion-collapse');
            states[widgetName] = collapseElement.classList.contains('show');
        });
        localStorage.setItem(WIDGET_STATE_KEY, JSON.stringify(states));
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«çŠ¶æ…‹ã‚’å¾©å…ƒ
    applyWidgetStates();

    // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒé–‹ã‹ã‚ŒãŸã‚Šé–‰ã˜ã‚‰ã‚ŒãŸã‚Šã—ãŸå¾Œã«ã€çŠ¶æ…‹ã‚’ä¿å­˜
    widgetsContainer.addEventListener('shown.bs.collapse', saveWidgetStates);
    widgetsContainer.addEventListener('hidden.bs.collapse', saveWidgetStates);
    // â–²â–²â–²ã€è¿½è¨˜ã¯ã“ã“ã¾ã§ã€‘â–²â–²â–²

    // â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰è¿½è¨˜ã€‘ã‚³ã‚¹ãƒˆè¡¨ç¤ºãƒˆã‚°ãƒ«æ©Ÿèƒ½ â–¼â–¼â–¼
    const costToggle = document.getElementById('cost-display-toggle');
    if (costToggle) {
        costToggle.addEventListener('change', function() {
            const csrfTokenEl = document.querySelector('meta[name="csrf-token"]');
            if (!csrfTokenEl) {
                alert('ã‚¨ãƒ©ãƒ¼: CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const csrfToken = csrfTokenEl.getAttribute('content');

            // ãƒˆã‚°ãƒ«æ“ä½œä¸­ã¯æ“ä½œä¸å¯ã«ã™ã‚‹
            this.disabled = true;

            fetch("{{ url_for('main.toggle_dashboard_cost_display') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (response.ok) {
                    // æˆåŠŸã—ãŸã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
                    window.location.reload();
                } else {
                    // å¤±æ•—ã—ãŸå ´åˆã€ãƒˆã‚°ãƒ«ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
                    this.checked = !this.checked;
                    this.disabled = false;
                    alert('è¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                }
            })
            .catch(error => {
                console.error('Error toggling cost display:', error);
                this.checked = !this.checked;
                this.disabled = false;
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            });
        });
    }
    // â–²â–²â–²ã€è¿½è¨˜ã¯ã“ã“ã¾ã§ã€‘â–²â–²â–²
});
</script>
{% endblock %}