{# motopuppu/templates/_breadcrumbs.html #}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        {# 常に表示される最初の階層 #}
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">ホーム</a></li>

        {# request.endpoint の値に応じて、2階層目以降を動的に生成 #}
        
        {# --- 車両管理 --- #}
        {% if request.endpoint.startswith('vehicle.') %}
            <li class="breadcrumb-item"><a href="{{ url_for('vehicle.vehicle_list') }}">車両管理</a></li>
            {% if request.endpoint == 'vehicle.edit_vehicle' %}
                <li class="breadcrumb-item active" aria-current="page">車両の編集</li>
            {% elif request.endpoint == 'vehicle.add_vehicle' %}
                 <li class="breadcrumb-item active" aria-current="page">車両の追加</li>
            {% endif %}
        {% endif %}

        {# --- 給油記録 --- #}
        {% if request.endpoint.startswith('fuel.') %}
             <li class="breadcrumb-item"><a href="{{ url_for('fuel.fuel_log') }}">給油記録</a></li>
            {% if request.endpoint == 'fuel.edit_fuel' %}
                <li class="breadcrumb-item active" aria-current="page">記録の編集</li>
            {% elif request.endpoint == 'fuel.add_fuel' %}
                 <li class="breadcrumb-item active" aria-current="page">記録の追加</li>
            {% endif %}
        {% endif %}

        {# --- 整備記録 --- #}
        {% if request.endpoint.startswith('maintenance.') %}
             <li class="breadcrumb-item"><a href="{{ url_for('maintenance.maintenance_log') }}">整備記録</a></li>
            {% if request.endpoint == 'maintenance.edit_maintenance' %}
                <li class="breadcrumb-item active" aria-current="page">記録の編集</li>
            {% elif request.endpoint == 'maintenance.add_maintenance' %}
                 <li class="breadcrumb-item active" aria-current="page">記録の追加</li>
            {% endif %}
        {% endif %}
        
        {# --- ノート --- #}
        {% if request.endpoint.startswith('notes.') %}
             <li class="breadcrumb-item"><a href="{{ url_for('notes.notes_log') }}">ノート</a></li>
            {% if request.endpoint == 'notes.edit_note' %}
                <li class="breadcrumb-item active" aria-current="page">ノートの編集</li>
            {% elif request.endpoint == 'notes.add_note' %}
                 <li class="breadcrumb-item active" aria-current="page">ノートの追加</li>
            {% endif %}
        {% endif %}

        {# --- リマインダー --- #}
        {% if request.endpoint.startswith('reminder.') %}
             <li class="breadcrumb-item"><a href="{{ url_for('reminder.list_reminders', vehicle_id=request.view_args.get('vehicle_id', g.user_motorcycles[0].id if g.user_motorcycles else 0)) }}">リマインダー</a></li>
            {% if request.endpoint == 'reminder.edit_reminder' %}
                <li class="breadcrumb-item active" aria-current="page">リマインダーの編集</li>
            {% elif request.endpoint == 'reminder.add_reminder' %}
                 <li class="breadcrumb-item active" aria-current="page">リマインダーの追加</li>
            {% endif %}
        {% endif %}

        {# --- 活動記録 (走行ログ) --- #}
        {% if request.endpoint.startswith('activity.') %}
            <li class="breadcrumb-item"><a href="{{ url_for('activity.list_activities', vehicle_id=request.view_args.get('vehicle_id', g.user_motorcycles[0].id if g.user_motorcycles else 0)) }}">走行ログ</a></li>
            {% if request.endpoint in ['activity.detail_activity', 'activity.edit_activity', 'activity.add_session', 'activity.edit_session'] %}
                <li class="breadcrumb-item active" aria-current="page">詳細・編集</li>
            {% endif %}
        {% endif %}

        {# --- 活動記録 (ツーリングログ) --- #}
        {% if request.endpoint.startswith('touring.') %}
            {# 変数を定義して、vehicle_idを安全に取得 #}
            {% set vehicle_id_from_args = request.view_args.get('vehicle_id') %}
            {% set final_vehicle_id = vehicle_id_from_args %}
            {# 詳細・編集ページでは、テンプレートに渡されたlogオブジェクトからmotorcycle_idを取得 #}
            {% if not final_vehicle_id and log is defined and log %}
                {% set final_vehicle_id = log.motorcycle_id %}
            {# それでもなければ、ログインユーザーのデフォルト車両にフォールバック #}
            {% elif not final_vehicle_id and g.user_motorcycles %}
                {% set final_vehicle_id = g.user_motorcycles[0].id %}
            {% endif %}
            
            {# 2階層目のリンクを生成 #}
            <li class="breadcrumb-item"><a href="{{ url_for('touring.list_logs', vehicle_id=final_vehicle_id if final_vehicle_id else 0) }}">ツーリングログ</a></li>
            
            {# 3階層目のテキストを動的に設定 #}
            {% if request.endpoint == 'touring.detail_log' %}
                <li class="breadcrumb-item active" aria-current="page">{{ log.title if log else '詳細' }}</li>
            {% elif request.endpoint == 'touring.edit_log' %}
                <li class="breadcrumb-item active" aria-current="page">{{ '「%s」の編集' % log.title if log else '編集' }}</li>
            {% elif request.endpoint == 'touring.create_log' %}
                <li class="breadcrumb-item active" aria-current="page">ログの追加</li>
            {% endif %}
        {% endif %}

        {# --- リーダーボード --- #}
        {% if request.endpoint.startswith('leaderboard.') %}
            <li class="breadcrumb-item active" aria-current="page">リーダーボード</li>
        {% endif %}

        {# --- イベント --- #}
        {% if request.endpoint.startswith('event.') %}
            <li class="breadcrumb-item"><a href="{{ url_for('event.list_events') }}">イベント管理</a></li>
             {% if request.endpoint in ['event.event_detail', 'event.edit_event'] %}
                <li class="breadcrumb-item active" aria-current="page">詳細・編集</li>
            {% elif request.endpoint == 'event.add_event' %}
                 <li class="breadcrumb-item active" aria-current="page">イベントの追加</li>
            {% endif %}
        {% endif %}

        {# --- 実績 --- #}
        {% if request.endpoint.startswith('achievements.') %}
            <li class="breadcrumb-item active" aria-current="page">実績一覧</li>
        {% endif %}

        {# --- 整備情報シート --- #}
        {% if request.endpoint.startswith('spec_sheet.') %}
            <li class="breadcrumb-item"><a href="{{ url_for('vehicle.vehicle_list') }}">車両管理</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('spec_sheet.list_sheets', vehicle_id=request.view_args.get('vehicle_id')) }}">整備情報シート</a></li>
             {% if request.endpoint == 'spec_sheet.edit_sheet' %}
                <li class="breadcrumb-item active" aria-current="page">編集</li>
            {% elif request.endpoint == 'spec_sheet.add_sheet' %}
                 <li class="breadcrumb-item active" aria-current="page">追加</li>
            {% endif %}
        {% endif %}

        {# --- プロフィール設定 --- #}
        {% if request.endpoint.startswith('profile.') %}
            <li class="breadcrumb-item active" aria-current="page">プロフィール設定</li>
        {% endif %}

        {# --- サーキットダッシュボード --- #}
        {% if request.endpoint.startswith('circuit_dashboard.') %}
            <li class="breadcrumb-item active" aria-current="page">サーキットダッシュボード</li>
        {% endif %}

        {# --- ガレージ設定 --- #}
        {% if request.endpoint.startswith('garage_settings.') %}
            <li class="breadcrumb-item active" aria-current="page">ガレージ設定</li>
        {% endif %}
        
    </ol>
</nav>