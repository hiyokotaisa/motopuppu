{# motopuppu/templates/odo_reset_log_form.html #}
{% extends "base.html" %}

{# ▼▼▼ タイトルを動的に変更 ▼▼▼ #}
{% set page_title = "過去のODOリセット履歴を追加" if form_action == 'add' else "ODOリセット履歴の編集" %}
{% block title %}{{ page_title }} - もとぷっぷー{% endblock %}

{% block content %}
{# ▼▼▼ 見出しも動的に変更 ▼▼▼ #}
<h2>{{ page_title }}</h2>

{# --- フラッシュメッセージ表示 --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}
{# --- フラッシュメッセージ表示 ここまで --- #}

{# ▼▼▼ フォームの action を削除し、現在のURLにPOSTするように変更 ▼▼▼ #}
<form method="POST"> 
    {# CSRFトークン #}
    
    {# ▼▼▼ 車両名はビューから渡された vehicle または log.motorcycle を使う ▼▼▼ #}
    <p>車両: <strong>{{ vehicle.name if vehicle else log.motorcycle.name }}</strong></p>

    <div class="mb-3">
        <label for="reset_date" class="form-label">リセット日 <span class="text-danger">*</span></label>
        {# ▼▼▼ value の設定を調整 (追加時は now_date_iso, 編集時は log.reset_date) ▼▼▼ #}
        <input type="date" class="form-control" id="reset_date" name="reset_date" 
                value="{{ request.form['reset_date'] if request.form else (log.reset_date.isoformat() if log else now_date_iso) }}" 
                required>
        {# ▲▲▲ 修正ここまで ▲▲▲ #}
    </div>

    <div class="mb-3">
        <label for="display_odo_before_reset" class="form-label">リセット直前のメーター表示値 <span class="text-danger">*</span></label>
        {# ▼▼▼ value の設定を調整 (追加時は空, 編集時は log の値) ▼▼▼ #}
        <input type="number" class="form-control" id="display_odo_before_reset" name="display_odo_before_reset" 
                value="{{ request.form['display_odo_before_reset'] if request.form else (log.display_odo_before_reset if log else '') }}" 
                required min="0">
        {# ▲▲▲ 修正ここまで ▲▲▲ #}
    </div>

    <div class="mb-3">
        <label for="display_odo_after_reset" class="form-label">リセット直後のメーター表示値 <span class="text-danger">*</span></label>
        {# ▼▼▼ value の設定を調整 (追加時は 0, 編集時は log の値) ▼▼▼ #}
        <input type="number" class="form-control" id="display_odo_after_reset" name="display_odo_after_reset" 
                value="{{ request.form['display_odo_after_reset'] if request.form else (log.display_odo_after_reset if log is not none and log.display_odo_after_reset is not none else '0') }}" 
                required min="0">
        {# ▲▲▲ 修正ここまで (logがNoneでないかもチェック) ▲▲▲ #}
    </div>

    <div class="mt-4">
        {# ▼▼▼ ボタンテキストを動的に変更 ▼▼▼ #}
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> {{ '追加する' if form_action == 'add' else '更新する' }}
        </button>
        {# ▼▼▼ キャンセルボタンの戻り先を調整 ▼▼▼ #}
        <a href="{{ url_for('vehicle.edit_vehicle', vehicle_id=(vehicle.id if vehicle else log.motorcycle_id)) }}" class="btn btn-secondary">
            <i class="fas fa-times me-1"></i> キャンセル
        </a>
        {# ▲▲▲ 修正ここまで ▲▲▲ #}
    </div>
</form>

{% endblock %}