{# motopuppu/templates/dashboard/_stats_widget.html #}
<div class="accordion-item card mb-4" data-widget-name="stats">
    <h2 class="accordion-header d-flex align-items-center" id="heading-stats">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-stats" aria-expanded="true" aria-controls="collapse-stats">
            <span class="widget-grab-handle me-2" title="ドラッグして並び替え"><i class="fas fa-grip-vertical"></i></span>
            <span class="me-auto"><i class="fas fa-chart-line me-1"></i> <strong>統計情報</strong></span>
        </button>
        <form method="GET" action="{{ url_for('main.dashboard') }}" class="d-inline-block p-2" style="min-width: 180px;">
            <input type="hidden" name="timeline_vehicle_id" value="{{ selected_timeline_vehicle_id or '' }}">
            {% if period != 'all' %}
                <input type="hidden" name="period" value="{{ period }}">
                <input type="hidden" name="start_date" value="{{ start_date_str }}">
                <input type="hidden" name="end_date" value="{{ end_date_str }}">
            {% endif %}
            <select name="stats_vehicle_id" class="form-select form-select-sm" onchange="this.form.submit()" aria-label="統計対象車両で絞り込み">
                <option value="" {% if not selected_stats_vehicle_id %}selected{% endif %}>すべての車両 (デフォルト)</option>
                {% for m_stats in motorcycles %}
                <option value="{{ m_stats.id }}" {% if selected_stats_vehicle_id == m_stats.id %}selected{% endif %}>{{ m_stats.name }} {% if m_stats.is_racer %}(レーサー){% endif %}</option>
                {% endfor %}
            </select>
        </form>
    </h2>
    <div id="collapse-stats" class="accordion-collapse collapse show" aria-labelledby="heading-stats">
        {% if dashboard_stats %}
        <div class="card-body pb-0">
            <form method="GET" action="{{ url_for('main.dashboard') }}" id="period-filter-form">
                <input type="hidden" name="timeline_vehicle_id" value="{{ selected_timeline_vehicle_id or '' }}">
                <input type="hidden" name="stats_vehicle_id" value="{{ selected_stats_vehicle_id or '' }}">
                <div class="row gx-2 gy-2 align-items-center">
                    <div class="col-auto"><label class="form-label mb-0 small text-muted">表示期間:</label></div>
                    <div class="col-auto">
                        <div class="btn-group" role="group">
                            <button type="submit" name="period" value="1m" class="btn btn-sm {% if period == '1m' %}btn-primary{% else %}btn-outline-primary{% endif %}">1ヶ月</button>
                            <button type="submit" name="period" value="6m" class="btn btn-sm {% if period == '6m' %}btn-primary{% else %}btn-outline-primary{% endif %}">6ヶ月</button>
                            <button type="submit" name="period" value="1y" class="btn btn-sm {% if period == '1y' %}btn-primary{% else %}btn-outline-primary{% endif %}">1年</button>
                            <a href="{{ url_for('main.dashboard', stats_vehicle_id=selected_stats_vehicle_id, timeline_vehicle_id=selected_timeline_vehicle_id) }}" class="btn btn-sm {% if period == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">全期間</a>
                        </div>
                    </div>
                    <div class="col-auto"><label for="start_date" class="form-label mb-0 small text-muted">カスタム:</label></div>
                    <div class="col-auto"><input type="date" class="form-control form-control-sm" id="start_date" name="start_date" value="{{ start_date_str }}" max="{{ current_date_str }}" style="width: 140px;"></div>
                    <div class="col-auto px-0">-</div>
                    <div class="col-auto"><input type="date" class="form-control form-control-sm" id="end_date" name="end_date" value="{{ end_date_str }}" max="{{ current_date_str }}" style="width: 140px;"></div>
                    <div class="col-auto"><button type="submit" name="period" value="custom" class="btn btn-sm btn-success">適用</button></div>
                </div>
            </form>
            <hr class="mt-3 mb-0">
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3 col-6 mb-3 mb-md-0">
                    <h6 class="card-title text-muted small">{% if dashboard_stats.is_racer_stats %}総稼働時間{% else %}{% if period != 'all' %}期間内{% endif %}走行距離{% endif %}</h6>
                    <p class="card-text fs-4 fw-bold mb-0">{% if dashboard_stats.is_racer_stats %}{{ "%.2f"|format(dashboard_stats.primary_metric_val) }}{% else %}{{ "{:,.0f}".format(dashboard_stats.primary_metric_val | int) }}{% endif %}<small class="fs-6">{{ dashboard_stats.primary_metric_unit }}</small></p>
                    <small class="text-muted">({{ dashboard_stats.primary_metric_label }})</small>
                </div>
                <div class="col-md-3 col-6 mb-3 mb-md-0">
                    <h6 class="card-title text-muted small">平均燃費</h6>
                    {% if dashboard_stats.average_kpl_val is not none %}<p class="card-text fs-4 fw-bold mb-0">{{ "%.2f"|format(dashboard_stats.average_kpl_val) }} <small class="fs-6">km/L</small></p><small class="text-muted">({{ dashboard_stats.average_kpl_label }})</small>{% else %}<p class="card-text fs-4 fw-bold mb-0">-</p><small class="text-muted">({{ dashboard_stats.average_kpl_label }})</small>{% endif %}
                </div>
                <div class="col-md-3 col-6">
                    <h6 class="card-title text-muted small">{% if period != 'all' %}期間内{% else %}累計{% endif %} 給油費用</h6>
                    <p class="card-text fs-4 fw-bold mb-0">{{ "{:,.0f}".format(dashboard_stats.total_fuel_cost | int) }} <small class="fs-6">円</small></p>
                    <small class="text-muted">({{ dashboard_stats.cost_label }})</small>
                </div>
                <div class="col-md-3 col-6">
                    <h6 class="card-title text-muted small">{% if period != 'all' %}期間内{% else %}累計{% endif %} 整備費用</h6>
                    <p class="card-text fs-4 fw-bold mb-0">{{ "{:,.0f}".format(dashboard_stats.total_maint_cost | int) }} <small class="fs-6">円</small></p>
                    <small class="text-muted">({{ dashboard_stats.cost_label }})</small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card-body">
            <p class="text-muted mb-0">統計データを表示できません。</p>
        </div>
        {% endif %}
    </div>
</div>